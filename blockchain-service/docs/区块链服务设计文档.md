# 区块链存证服务设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | EduChain 区块链存证服务 |
| 服务名称 | blockchain-service |
| 开发语言 | Python 3.11+ |
| 主要框架 | FastAPI |
| 版本 | 1.0.0 |
| 创建时间 | 2025年 |

---

## 一、系统概述

### 1.1 项目背景

在教育知识共享平台中，知识内容的原创性和版权保护是核心需求。传统的中心化存储方式存在数据可被篡改、难以证明创作时间等问题。本系统引入区块链技术，为教育内容提供不可篡改的存证服务。

### 1.2 系统定位

本区块链服务是一个**数据存证系统**，专注于：
- 知识内容的哈希存证
- 创作时间的不可篡改记录
- 内容完整性验证
- 存证证书生成

**重要说明**：本系统不涉及虚拟货币、代币发行或挖矿机制，是纯粹的数据存证应用。

### 1.3 核心功能

1. **内容存证**：将知识内容的哈希值记录到区块链
2. **内容验证**：验证内容是否被篡改
3. **证书生成**：生成PDF格式的存证证书
4. **二维码验证**：支持扫码验证证书真伪

### 1.4 技术架构


```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EduChain 区块链存证服务架构                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          API 层 (FastAPI)                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │   │
│  │  │ 存证API │  │ 验证API │  │ 查询API │  │ 证书API │  │ 统计API │   │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         核心业务层                                    │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │   │
│  │  │  Blockchain   │  │  Transaction  │  │     Block     │            │   │
│  │  │   区块链核心   │  │    交易管理    │  │    区块管理    │            │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘            │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │   │
│  │  │  Certificate  │  │  PDF Generator│  │  QR Generator │            │   │
│  │  │   证书生成     │  │   PDF生成器    │  │   二维码生成   │            │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据持久层                                   │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    SQLAlchemy ORM                              │  │   │
│  │  │                    SQLite / MySQL                              │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、技术选型

### 2.1 开发框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 开发语言 |
| FastAPI | ≥0.115.0 | Web框架 |
| Uvicorn | ≥0.32.0 | ASGI服务器 |
| Pydantic | ≥2.10.0 | 数据验证 |
| SQLAlchemy | ≥2.0.36 | ORM框架 |
| ReportLab | ≥4.0.0 | PDF生成 |
| qrcode | ≥7.4.2 | 二维码生成 |
| Pillow | ≥10.0.0 | 图像处理 |

### 2.2 选型理由

1. **FastAPI**：高性能异步框架，自动生成API文档，类型提示支持
2. **SQLAlchemy**：成熟的ORM框架，支持多种数据库
3. **ReportLab**：专业的PDF生成库，支持复杂排版
4. **qrcode**：简单易用的二维码生成库

---

## 三、目录结构

```
blockchain-service/
├── app/                          # 应用主目录
│   ├── __init__.py              # 包初始化
│   ├── api.py                   # FastAPI路由和接口定义
│   ├── block.py                 # 区块数据结构
│   ├── blockchain.py            # 区块链核心逻辑
│   ├── certificate.py           # 证书数据结构和生成
│   ├── certificate_pdf.py       # PDF证书生成器
│   ├── config.py                # 配置管理
│   ├── qr_code.py               # 二维码生成器
│   ├── transaction.py           # 交易数据结构
│   └── database/                # 数据库模块
│       ├── __init__.py
│       └── db_manager.py        # 数据库管理器
├── certificates/                 # 生成的证书存储目录
├── qrcodes/                      # 生成的二维码存储目录
├── main.py                       # 服务入口
├── requirements.txt              # Python依赖
├── Dockerfile                    # Docker构建文件
└── blockchain.db                 # SQLite数据库文件
```

---


## 四、核心模块设计

### 4.1 区块结构（Block）

区块是区块链的基本单元，每个区块包含一组交易记录。

```python
@dataclass
class Block:
    index: int                    # 区块索引（从0开始）
    timestamp: str                # 创建时间（ISO格式）
    transactions: List[Transaction]  # 交易列表
    previous_hash: str            # 前一区块哈希
    hash: str                     # 当前区块哈希
```

**区块哈希计算**：
```python
def calculate_hash(self) -> str:
    block_string = json.dumps({
        'index': self.index,
        'timestamp': self.timestamp,
        'transactions': [tx.to_dict() for tx in self.transactions],
        'previous_hash': self.previous_hash
    }, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(block_string.encode('utf-8')).hexdigest()
```

### 4.2 交易结构（Transaction）

交易记录存证信息，支持多种类型。

```python
@dataclass
class Transaction:
    type: str                     # 交易类型
    knowledge_id: Optional[int]   # 知识内容ID
    user_id: Optional[int]        # 用户ID
    content_hash: Optional[str]   # 内容哈希值（SHA-256）
    metadata: Dict[str, Any]      # 额外元数据
    timestamp: Optional[str]      # 时间戳
    signature: Optional[str]      # 数字签名（预留）
    public_key: Optional[str]     # 公钥（预留）
```

**交易类型定义**：

| 类型常量 | 值 | 说明 |
|----------|-----|------|
| TYPE_KNOWLEDGE_CERT | KNOWLEDGE_CERTIFICATION | 知识内容存证 |
| TYPE_ACHIEVEMENT | ACHIEVEMENT | 用户成就认证 |
| TYPE_COPYRIGHT | COPYRIGHT | 版权声明 |
| TYPE_USER_ACTION | USER_ACTION | 用户行为记录 |

### 4.3 区块链核心（Blockchain）

区块链类管理整个链的生命周期。

**核心方法**：

| 方法 | 功能 | 返回值 |
|------|------|--------|
| `create_genesis_block()` | 创建创世区块 | void |
| `add_transaction(tx)` | 添加交易到待处理队列 | 预计区块索引 |
| `create_block()` | 打包交易创建新区块 | Block对象 |
| `is_chain_valid()` | 验证链完整性 | bool |
| `verify_knowledge(id, hash)` | 验证知识内容 | bool |
| `get_transaction_by_knowledge_id(id)` | 按知识ID查询交易 | Transaction |

**链验证逻辑**：
```python
def is_chain_valid(self) -> bool:
    for i in range(1, len(self.chain)):
        current_block = self.chain[i]
        previous_block = self.chain[i - 1]
        
        # 验证当前区块哈希
        if current_block.hash != current_block.calculate_hash():
            return False
        
        # 验证链接关系
        if current_block.previous_hash != previous_block.hash:
            return False
    
    return True
```

### 4.4 证书生成模块

**证书数据结构**：
```python
@dataclass
class CertificateData:
    certificate_id: str      # 证书编号（CERT-YYYY-NNNNNN）
    knowledge_id: int        # 知识ID
    knowledge_title: str     # 知识标题
    user_id: int             # 用户ID
    user_name: str           # 用户名
    content_hash: str        # 内容哈希
    block_index: int         # 区块索引
    block_hash: str          # 区块哈希
    timestamp: str           # 存证时间
    verification_url: str    # 验证地址
```

**证书编号生成规则**：
- 格式：`CERT-YYYY-NNNNNN`
- YYYY：年份
- NNNNNN：基于知识ID和区块索引的6位唯一编号

---

## 五、数据库设计

### 5.1 区块存储表（blocks）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| index | INTEGER | UNIQUE, NOT NULL | 区块索引 |
| timestamp | DATETIME | NOT NULL | 区块时间戳 |
| previous_hash | VARCHAR(64) | NOT NULL | 前一区块哈希 |
| hash | VARCHAR(64) | NOT NULL | 当前区块哈希 |
| transactions_json | TEXT | NOT NULL | 交易JSON数据 |
| created_at | DATETIME | DEFAULT NOW | 记录创建时间 |

### 5.2 数据库操作

```python
class BlockchainDB:
    def save_block(self, block: Block) -> bool:
        """保存区块到数据库"""
        
    def load_chain(self) -> List[Block]:
        """从数据库加载完整区块链"""
        
    def get_block_count(self) -> int:
        """获取区块数量"""
        
    def get_latest_block(self) -> Optional[BlockModel]:
        """获取最新区块"""
```

---


## 六、API接口设计

### 6.1 接口总览

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/` | 服务信息 |
| GET | `/health` | 健康检查 |
| POST | `/api/blockchain/certify` | 内容存证 |
| POST | `/api/blockchain/verify` | 内容验证 |
| GET | `/api/blockchain/chain` | 获取链信息 |
| POST | `/api/blockchain/create-block` | 手动创建区块 |
| GET | `/api/blockchain/transaction/{knowledge_id}` | 查询交易 |
| GET | `/api/blockchain/block/{index}` | 查询区块 |
| GET | `/api/blockchain/user/{user_id}/transactions` | 用户交易列表 |
| GET | `/api/blockchain/stats` | 统计信息 |
| POST | `/api/blockchain/certificates` | 生成证书 |
| GET | `/api/blockchain/certificates/{id}/download` | 下载证书 |
| GET | `/api/blockchain/certificates/{id}/verify` | 验证证书 |

### 6.2 核心接口详细说明

#### 6.2.1 内容存证接口

**请求**：
```http
POST /api/blockchain/certify
Content-Type: application/json

{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 12345,
    "user_id": 1001,
    "content_hash": "a1b2c3d4e5f6...(64位SHA-256哈希)",
    "metadata": {
        "title": "知识标题",
        "category": "前端开发"
    }
}
```

**响应**：
```json
{
    "transaction_id": 1,
    "block_index": 5,
    "status": "confirmed",
    "timestamp": "2025-01-15T10:30:00.000000"
}
```

#### 6.2.2 内容验证接口

**请求**：
```http
POST /api/blockchain/verify
Content-Type: application/json

{
    "knowledge_id": 12345,
    "content_hash": "a1b2c3d4e5f6...(64位SHA-256哈希)"
}
```

**响应**：
```json
{
    "is_valid": true,
    "block_index": 5,
    "transaction_timestamp": "2025-01-15T10:30:00.000000",
    "message": "验证成功"
}
```

#### 6.2.3 生成证书接口

**请求**：
```http
POST /api/blockchain/certificates
Content-Type: application/json

{
    "knowledge_id": 12345,
    "knowledge_title": "React Hooks 完全指南",
    "user_id": 1001,
    "user_name": "张三"
}
```

**响应**：
```json
{
    "certificate_id": "CERT-2025-123456",
    "knowledge_id": 12345,
    "block_index": 5,
    "pdf_url": "http://localhost:8000/api/blockchain/certificates/CERT-2025-123456/download",
    "qr_code_url": "http://localhost:8000/qrcodes/cert_CERT-2025-123456.png",
    "verification_url": "https://educhain.cc/blockchain/certificates/CERT-2025-123456/verify",
    "created_at": "2025-01-15T10:35:00.000000"
}
```

#### 6.2.4 获取区块链信息

**请求**：
```http
GET /api/blockchain/chain
```

**响应**：
```json
{
    "chain_length": 100,
    "pending_transactions_count": 3,
    "is_valid": true,
    "latest_block_index": 99,
    "latest_block_hash": "abc123def456..."
}
```

#### 6.2.5 获取统计信息

**请求**：
```http
GET /api/blockchain/stats
```

**响应**：
```json
{
    "total_blocks": 100,
    "total_transactions": 500,
    "pending_transactions": 3,
    "transaction_types": {
        "KNOWLEDGE_CERTIFICATION": 450,
        "ACHIEVEMENT": 30,
        "COPYRIGHT": 20
    },
    "is_valid": true
}
```

---

## 七、业务流程

### 7.1 内容存证流程

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户    │     │  主系统      │     │ 区块链服务   │     │   数据库    │
└────┬────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                   │                   │
     │  1.发布知识内容  │                   │                   │
     │────────────────▶│                   │                   │
     │                 │                   │                   │
     │                 │  2.计算内容哈希    │                   │
     │                 │  SHA-256(content) │                   │
     │                 │                   │                   │
     │                 │  3.请求存证        │                   │
     │                 │──────────────────▶│                   │
     │                 │                   │                   │
     │                 │                   │  4.创建交易        │
     │                 │                   │  验证交易有效性    │
     │                 │                   │                   │
     │                 │                   │  5.打包成区块      │
     │                 │                   │  计算区块哈希      │
     │                 │                   │                   │
     │                 │                   │  6.保存区块        │
     │                 │                   │──────────────────▶│
     │                 │                   │                   │
     │                 │  7.返回存证结果    │                   │
     │                 │◀──────────────────│                   │
     │                 │                   │                   │
     │  8.显示存证成功  │                   │                   │
     │◀────────────────│                   │                   │
     │                 │                   │                   │
```

### 7.2 内容验证流程

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐
│  用户    │     │  主系统      │     │ 区块链服务   │
└────┬────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                   │
     │  1.请求验证内容  │                   │
     │────────────────▶│                   │
     │                 │                   │
     │                 │  2.计算当前内容哈希│
     │                 │  SHA-256(content) │
     │                 │                   │
     │                 │  3.请求验证        │
     │                 │──────────────────▶│
     │                 │                   │
     │                 │                   │  4.查找原始交易
     │                 │                   │  比对哈希值
     │                 │                   │
     │                 │  5.返回验证结果    │
     │                 │◀──────────────────│
     │                 │                   │
     │  6.显示验证结果  │                   │
     │  (是否被篡改)    │                   │
     │◀────────────────│                   │
     │                 │                   │
```

### 7.3 证书生成流程

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户    │     │  主系统      │     │ 区块链服务   │     │  文件系统   │
└────┬────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                   │                   │
     │  1.请求生成证书  │                   │                   │
     │────────────────▶│                   │                   │
     │                 │                   │                   │
     │                 │  2.请求生成证书    │                   │
     │                 │──────────────────▶│                   │
     │                 │                   │                   │
     │                 │                   │  3.查找存证交易    │
     │                 │                   │  获取区块信息      │
     │                 │                   │                   │
     │                 │                   │  4.生成证书编号    │
     │                 │                   │  创建证书数据      │
     │                 │                   │                   │
     │                 │                   │  5.生成二维码      │
     │                 │                   │──────────────────▶│
     │                 │                   │                   │
     │                 │                   │  6.生成PDF证书     │
     │                 │                   │──────────────────▶│
     │                 │                   │                   │
     │                 │  7.返回证书信息    │                   │
     │                 │◀──────────────────│                   │
     │                 │                   │                   │
     │  8.下载证书PDF   │                   │                   │
     │◀────────────────│                   │                   │
     │                 │                   │                   │
```

---


## 八、安全设计

### 8.1 数据完整性保障

1. **哈希链接**：每个区块包含前一区块的哈希值，形成不可断裂的链条
2. **SHA-256算法**：使用密码学安全的哈希算法
3. **链验证机制**：支持完整链的有效性验证

### 8.2 防篡改机制

```
区块N-1                    区块N                      区块N+1
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ index: N-1      │       │ index: N        │       │ index: N+1      │
│ timestamp       │       │ timestamp       │       │ timestamp       │
│ transactions    │       │ transactions    │       │ transactions    │
│ previous_hash   │◀──────│ previous_hash   │◀──────│ previous_hash   │
│ hash: ABC123    │───────│ hash: DEF456    │───────│ hash: GHI789    │
└─────────────────┘       └─────────────────┘       └─────────────────┘

如果区块N的数据被篡改：
1. 区块N的hash会改变（假设变为XYZ000）
2. 区块N+1的previous_hash（DEF456）与区块N的新hash（XYZ000）不匹配
3. 链验证失败，篡改被检测
```

### 8.3 API安全

1. **CORS配置**：限制跨域访问来源
2. **输入验证**：使用Pydantic进行请求数据验证
3. **错误处理**：统一的异常处理，不暴露敏感信息

### 8.4 数据安全

1. **内容哈希**：只存储内容哈希，不存储原始内容
2. **数据库持久化**：区块数据持久化存储
3. **备份机制**：支持数据库备份和恢复

---

## 九、部署说明

### 9.1 环境要求

| 项目 | 要求 |
|------|------|
| Python | 3.11+ |
| 内存 | ≥512MB |
| 磁盘 | ≥1GB |
| 操作系统 | Linux/macOS/Windows |

### 9.2 本地开发部署

```bash
# 1. 进入项目目录
cd blockchain-service

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate   # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 启动服务
python main.py
```

### 9.3 Docker部署

```bash
# 构建镜像
docker build -t educhain-blockchain:latest .

# 运行容器
docker run -d \
  --name blockchain-service \
  -p 8000:8000 \
  -v $(pwd)/blockchain.db:/app/blockchain.db \
  -v $(pwd)/certificates:/app/certificates \
  -v $(pwd)/qrcodes:/app/qrcodes \
  educhain-blockchain:latest
```

### 9.4 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| HOST | 0.0.0.0 | 服务监听地址 |
| PORT | 8000 | 服务端口 |
| DATABASE_URL | sqlite:///blockchain.db | 数据库连接URL |
| AUTO_CREATE_BLOCK | true | 是否自动创建区块 |
| CREATE_BLOCK_INTERVAL | 60 | 自动创建区块间隔（秒） |
| CORS_ORIGINS | * | 允许的跨域来源 |
| LOG_LEVEL | INFO | 日志级别 |

### 9.5 生产环境配置建议

```python
# 生产环境配置示例
HOST = "0.0.0.0"
PORT = 8000
DATABASE_URL = "mysql://user:password@localhost/blockchain_db"
CORS_ORIGINS = "https://educhain.cc,https://www.educhain.cc"
LOG_LEVEL = "WARNING"
```

---

## 十、测试说明

### 10.1 API测试

服务启动后，访问 `http://localhost:8000/docs` 可查看Swagger API文档并进行在线测试。

### 10.2 测试用例

#### 测试1：存证功能
```bash
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1,
    "user_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }'
```

#### 测试2：验证功能
```bash
curl -X POST "http://localhost:8000/api/blockchain/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }'
```

#### 测试3：查询链信息
```bash
curl "http://localhost:8000/api/blockchain/chain"
```

---

## 十一、扩展性设计

### 11.1 预留扩展点

1. **数字签名**：Transaction类预留了signature和public_key字段
2. **多种数据库**：支持SQLite、MySQL、PostgreSQL
3. **分布式部署**：可扩展为多节点部署

### 11.2 未来优化方向

1. **共识机制**：可引入简化的共识算法
2. **智能合约**：支持简单的规则引擎
3. **性能优化**：引入缓存机制
4. **监控告警**：集成Prometheus监控

---

## 附录A：错误码定义

| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| 400 | Bad Request | 请求参数无效 |
| 404 | Not Found | 资源不存在 |
| 500 | Internal Server Error | 服务器内部错误 |

---

## 附录B：哈希计算示例

```python
import hashlib

def calculate_content_hash(content: str) -> str:
    """计算内容的SHA-256哈希值"""
    return hashlib.sha256(content.encode('utf-8')).hexdigest()

# 示例
content = "这是一篇关于React Hooks的教程..."
content_hash = calculate_content_hash(content)
print(f"Content Hash: {content_hash}")
# 输出: Content Hash: a1b2c3d4e5f6... (64位十六进制字符串)
```

---

**文档结束**

*本文档详细描述了EduChain区块链存证服务的设计与实现，可作为毕业设计的技术文档使用。*
