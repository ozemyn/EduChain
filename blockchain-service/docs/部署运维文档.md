# EduChain 区块链服务部署运维文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 服务名称 | blockchain-service |
| 版本 | 1.0.0 |
| 更新时间 | 2025年 |

---

## 一、环境要求

### 1.1 硬件要求

| 环境 | CPU | 内存 | 磁盘 |
|------|-----|------|------|
| 开发环境 | 1核 | 512MB | 1GB |
| 测试环境 | 2核 | 1GB | 5GB |
| 生产环境 | 4核+ | 4GB+ | 50GB+ |

### 1.2 软件要求

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Python | 3.11+ | 运行环境 |
| pip | 最新版 | 包管理器 |
| Docker | 20.10+ | 容器化部署（可选） |
| MySQL | 8.0+ | 生产数据库（可选） |

### 1.3 网络要求

| 端口 | 协议 | 用途 |
|------|------|------|
| 8000 | HTTP | API服务端口 |

---

## 二、本地开发部署

### 2.1 环境准备

```bash
# 检查Python版本
python --version  # 需要 3.11+

# 进入项目目录
cd blockchain-service
```

### 2.2 创建虚拟环境

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Linux/macOS
source venv/bin/activate

# Windows
venv\Scripts\activate
```

### 2.3 安装依赖

```bash
# 安装Python依赖
pip install -r requirements.txt
```

### 2.4 启动服务

```bash
# 方式1：使用main.py启动（开发模式，支持热重载）
python main.py

# 方式2：直接使用uvicorn启动
uvicorn app.api:app --host 0.0.0.0 --port 8000 --reload
```

### 2.5 验证服务

```bash
# 检查服务状态
curl http://localhost:8000/health

# 访问API文档
# 浏览器打开: http://localhost:8000/docs
```

---

## 三、Docker部署

### 3.1 构建镜像

```bash
# 进入项目目录
cd blockchain-service

# 构建Docker镜像
docker build -t educhain-blockchain:latest .

# 查看镜像
docker images | grep educhain-blockchain
```

### 3.2 运行容器

```bash
# 基础运行
docker run -d \
  --name blockchain-service \
  -p 8000:8000 \
  educhain-blockchain:latest

# 带数据持久化运行
docker run -d \
  --name blockchain-service \
  -p 8000:8000 \
  -v $(pwd)/data/blockchain.db:/app/blockchain.db \
  -v $(pwd)/data/certificates:/app/certificates \
  -v $(pwd)/data/qrcodes:/app/qrcodes \
  educhain-blockchain:latest

# 带环境变量运行
docker run -d \
  --name blockchain-service \
  -p 8000:8000 \
  -e DATABASE_URL="sqlite:///blockchain.db" \
  -e LOG_LEVEL="INFO" \
  educhain-blockchain:latest
```

### 3.3 容器管理

```bash
# 查看容器状态
docker ps | grep blockchain-service

# 查看容器日志
docker logs -f blockchain-service

# 进入容器
docker exec -it blockchain-service /bin/bash

# 停止容器
docker stop blockchain-service

# 启动容器
docker start blockchain-service

# 重启容器
docker restart blockchain-service

# 删除容器
docker rm -f blockchain-service
```

---

## 四、Docker Compose部署

### 4.1 docker-compose.yml

```yaml
version: '3.8'

services:
  blockchain-service:
    build: .
    container_name: educhain-blockchain
    ports:
      - "8000:8000"
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - DATABASE_URL=sqlite:///blockchain.db
      - LOG_LEVEL=INFO
      - CORS_ORIGINS=*
    volumes:
      - ./data/blockchain.db:/app/blockchain.db
      - ./data/certificates:/app/certificates
      - ./data/qrcodes:/app/qrcodes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  blockchain-data:
```

### 4.2 使用Docker Compose

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重建并启动
docker-compose up -d --build
```

---


## 五、生产环境部署

### 5.1 使用MySQL数据库

```bash
# 1. 创建MySQL数据库
mysql -u root -p
CREATE DATABASE blockchain_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'blockchain'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON blockchain_db.* TO 'blockchain'@'localhost';
FLUSH PRIVILEGES;

# 2. 配置环境变量
export DATABASE_URL="mysql+pymysql://blockchain:your_password@localhost/blockchain_db"

# 3. 安装MySQL驱动
pip install pymysql

# 4. 启动服务
python main.py
```

### 5.2 使用Gunicorn（生产WSGI服务器）

```bash
# 安装gunicorn
pip install gunicorn

# 启动服务（4个worker进程）
gunicorn app.api:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --access-logfile /var/log/blockchain/access.log \
  --error-logfile /var/log/blockchain/error.log
```

### 5.3 Nginx反向代理配置

```nginx
upstream blockchain_backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name blockchain.educhain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name blockchain.educhain.com;

    ssl_certificate /etc/nginx/ssl/educhain.com.crt;
    ssl_certificate_key /etc/nginx/ssl/educhain.com.key;

    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;

    # 日志
    access_log /var/log/nginx/blockchain_access.log;
    error_log /var/log/nginx/blockchain_error.log;

    # API代理
    location /api/ {
        proxy_pass http://blockchain_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查
    location /health {
        proxy_pass http://blockchain_backend;
    }

    # 静态文件（证书、二维码）
    location /certificates/ {
        alias /app/certificates/;
    }

    location /qrcodes/ {
        alias /app/qrcodes/;
    }
}
```

### 5.4 Systemd服务配置

```ini
# /etc/systemd/system/blockchain-service.service
[Unit]
Description=EduChain Blockchain Service
After=network.target mysql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/blockchain-service
Environment="PATH=/opt/blockchain-service/venv/bin"
Environment="DATABASE_URL=mysql+pymysql://blockchain:password@localhost/blockchain_db"
ExecStart=/opt/blockchain-service/venv/bin/gunicorn app.api:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 127.0.0.1:8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
# 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable blockchain-service
sudo systemctl start blockchain-service

# 查看状态
sudo systemctl status blockchain-service
```

---

## 六、环境变量配置

### 6.1 配置项说明

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| HOST | 0.0.0.0 | 服务监听地址 |
| PORT | 8000 | 服务端口 |
| DATABASE_URL | sqlite:///blockchain.db | 数据库连接URL |
| AUTO_CREATE_BLOCK | true | 是否自动创建区块 |
| CREATE_BLOCK_INTERVAL | 60 | 自动创建区块间隔（秒） |
| CORS_ORIGINS | * | 允许的跨域来源 |
| LOG_LEVEL | INFO | 日志级别 |

### 6.2 环境配置文件

```bash
# .env 文件示例
HOST=0.0.0.0
PORT=8000
DATABASE_URL=mysql+pymysql://user:password@localhost/blockchain_db
AUTO_CREATE_BLOCK=true
CREATE_BLOCK_INTERVAL=60
CORS_ORIGINS=https://educhain.com,https://www.educhain.com
LOG_LEVEL=INFO
```

### 6.3 不同环境配置

**开发环境**
```bash
DATABASE_URL=sqlite:///blockchain.db
LOG_LEVEL=DEBUG
CORS_ORIGINS=*
```

**测试环境**
```bash
DATABASE_URL=mysql+pymysql://test:test@localhost/blockchain_test
LOG_LEVEL=INFO
CORS_ORIGINS=http://localhost:3000
```

**生产环境**
```bash
DATABASE_URL=mysql+pymysql://prod:password@db.educhain.com/blockchain_prod
LOG_LEVEL=WARNING
CORS_ORIGINS=https://educhain.com
```

---

## 七、监控与日志

### 7.1 日志配置

```python
# 日志级别
# DEBUG: 调试信息
# INFO: 一般信息
# WARNING: 警告信息
# ERROR: 错误信息
# CRITICAL: 严重错误
```

### 7.2 日志查看

```bash
# Docker日志
docker logs -f blockchain-service --tail 100

# Systemd日志
journalctl -u blockchain-service -f

# 文件日志
tail -f /var/log/blockchain/access.log
tail -f /var/log/blockchain/error.log
```

### 7.3 健康检查

```bash
# 基础健康检查
curl http://localhost:8000/health

# 详细状态检查
curl http://localhost:8000/api/blockchain/stats
```

### 7.4 监控指标

| 指标 | 说明 | 告警阈值 |
|------|------|----------|
| chain_length | 区块链长度 | - |
| is_valid | 链有效性 | false时告警 |
| pending_transactions | 待处理交易数 | >100时告警 |
| response_time | 响应时间 | >1s时告警 |

---

## 八、备份与恢复

### 8.1 数据备份

```bash
# SQLite备份
cp blockchain.db blockchain.db.backup.$(date +%Y%m%d)

# MySQL备份
mysqldump -u blockchain -p blockchain_db > backup_$(date +%Y%m%d).sql

# 证书文件备份
tar -czvf certificates_backup_$(date +%Y%m%d).tar.gz certificates/
```

### 8.2 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/blockchain"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u blockchain -p'password' blockchain_db > $BACKUP_DIR/db_$DATE.sql

# 备份证书
tar -czvf $BACKUP_DIR/certificates_$DATE.tar.gz /app/certificates/

# 清理30天前的备份
find $BACKUP_DIR -type f -mtime +30 -delete

echo "Backup completed: $DATE"
```

### 8.3 数据恢复

```bash
# SQLite恢复
cp blockchain.db.backup blockchain.db

# MySQL恢复
mysql -u blockchain -p blockchain_db < backup_20250115.sql

# 证书恢复
tar -xzvf certificates_backup_20250115.tar.gz -C /app/
```

---

## 九、故障排查

### 9.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 服务无法启动 | 端口被占用 | 检查端口占用：`lsof -i:8000` |
| 数据库连接失败 | 连接字符串错误 | 检查DATABASE_URL配置 |
| 证书生成失败 | 目录权限不足 | 检查certificates目录权限 |
| 链验证失败 | 数据被篡改 | 检查数据库完整性 |

### 9.2 排查命令

```bash
# 检查服务状态
systemctl status blockchain-service

# 检查端口
netstat -tlnp | grep 8000

# 检查进程
ps aux | grep uvicorn

# 检查磁盘空间
df -h

# 检查内存
free -m

# 检查数据库连接
mysql -u blockchain -p -e "SELECT 1"
```

### 9.3 日志分析

```bash
# 查找错误日志
grep -i error /var/log/blockchain/error.log

# 查找慢请求
grep "took" /var/log/blockchain/access.log | awk '$NF > 1000'

# 统计请求量
cat /var/log/blockchain/access.log | wc -l
```

---

## 十、安全配置

### 10.1 生产环境安全清单

- [ ] 禁用DEBUG模式
- [ ] 配置CORS白名单
- [ ] 使用HTTPS
- [ ] 配置防火墙
- [ ] 定期备份数据
- [ ] 监控异常访问
- [ ] 更新依赖包

### 10.2 防火墙配置

```bash
# 只允许特定IP访问
ufw allow from 10.0.0.0/8 to any port 8000

# 或使用iptables
iptables -A INPUT -p tcp --dport 8000 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 8000 -j DROP
```

---

**文档结束**
