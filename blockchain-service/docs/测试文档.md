# EduChain 区块链服务测试文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 服务名称 | blockchain-service |
| 测试类型 | 功能测试、接口测试、安全测试 |
| 版本 | 1.0.0 |

---

## 一、测试环境

### 1.1 环境配置

| 项目 | 配置 |
|------|------|
| 操作系统 | macOS / Linux / Windows |
| Python版本 | 3.11+ |
| 数据库 | SQLite（测试）/ MySQL（生产） |
| 服务地址 | http://localhost:8000 |

### 1.2 测试工具

| 工具 | 用途 |
|------|------|
| curl | 命令行接口测试 |
| Swagger UI | 在线API测试 |
| pytest | 单元测试框架 |
| Postman | API测试工具 |

---

## 二、功能测试用例

### 2.1 存证功能测试

#### TC-001: 知识内容存证

**测试目的**：验证知识内容存证功能正常

**前置条件**：服务已启动

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1,
    "user_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
    "metadata": {"title": "测试知识"}
  }'
```

**预期结果**：
```json
{
    "transaction_id": 1,
    "block_index": 1,
    "status": "confirmed",
    "timestamp": "2025-01-15T10:30:00.000000"
}
```

**验证点**：
- [ ] 返回状态码200
- [ ] status为"confirmed"
- [ ] block_index大于0
- [ ] timestamp格式正确

---

#### TC-002: 无效交易拒绝

**测试目的**：验证系统拒绝无效的存证请求

**测试步骤**：
```bash
# 缺少必填字段
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1
  }'
```

**预期结果**：
```json
{
    "detail": "Invalid transaction"
}
```

**验证点**：
- [ ] 返回状态码400或422
- [ ] 返回错误信息

---

### 2.2 验证功能测试

#### TC-003: 内容验证通过

**测试目的**：验证未被篡改的内容能通过验证

**前置条件**：已完成TC-001存证

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }'
```

**预期结果**：
```json
{
    "is_valid": true,
    "block_index": 1,
    "transaction_timestamp": "2025-01-15T10:30:00.000000",
    "message": "验证成功"
}
```

**验证点**：
- [ ] is_valid为true
- [ ] message为"验证成功"

---

#### TC-004: 内容验证失败（哈希不匹配）

**测试目的**：验证被篡改的内容无法通过验证

**前置条件**：已完成TC-001存证

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "content_hash": "0000000000000000000000000000000000000000000000000000000000000000"
  }'
```

**预期结果**：
```json
{
    "is_valid": false,
    "block_index": 1,
    "transaction_timestamp": "2025-01-15T10:30:00.000000",
    "message": "哈希值不匹配"
}
```

**验证点**：
- [ ] is_valid为false
- [ ] message为"哈希值不匹配"

---

#### TC-005: 内容验证失败（未找到记录）

**测试目的**：验证未存证的内容返回正确信息

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 99999,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }'
```

**预期结果**：
```json
{
    "is_valid": false,
    "block_index": null,
    "transaction_timestamp": null,
    "message": "未找到相关交易"
}
```

---

### 2.3 查询功能测试

#### TC-006: 获取区块链信息

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/chain"
```

**预期结果**：
```json
{
    "chain_length": 2,
    "pending_transactions_count": 0,
    "is_valid": true,
    "latest_block_index": 1,
    "latest_block_hash": "..."
}
```

**验证点**：
- [ ] chain_length >= 1（至少有创世区块）
- [ ] is_valid为true

---

#### TC-007: 查询交易信息

**前置条件**：已完成TC-001存证

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/transaction/1"
```

**预期结果**：
```json
{
    "transaction": {
        "id": "...",
        "type": "KNOWLEDGE_CERTIFICATION",
        "knowledge_id": 1,
        "user_id": 1,
        "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "metadata": {"title": "测试知识"},
        "timestamp": "...",
        "signature": null,
        "public_key": null
    },
    "block_index": 1,
    "status": "confirmed"
}
```

---

#### TC-008: 查询不存在的交易

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/transaction/99999"
```

**预期结果**：
```json
{
    "detail": "Transaction not found"
}
```

**验证点**：
- [ ] 返回状态码404

---

#### TC-009: 查询区块信息

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/block/0"
```

**预期结果**：
```json
{
    "index": 0,
    "timestamp": "...",
    "transactions": [],
    "previous_hash": "0000000000000000000000000000000000000000000000000000000000000000",
    "hash": "..."
}
```

**验证点**：
- [ ] index为0（创世区块）
- [ ] transactions为空数组
- [ ] previous_hash为64个0

---

#### TC-010: 获取统计信息

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/stats"
```

**预期结果**：
```json
{
    "total_blocks": 2,
    "total_transactions": 1,
    "pending_transactions": 0,
    "transaction_types": {
        "KNOWLEDGE_CERTIFICATION": 1
    },
    "is_valid": true
}
```

---


### 2.4 证书功能测试

#### TC-011: 生成存证证书

**前置条件**：已完成TC-001存证

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certificates" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "knowledge_title": "测试知识",
    "user_id": 1,
    "user_name": "测试用户"
  }'
```

**预期结果**：
```json
{
    "certificate_id": "CERT-2025-123456",
    "knowledge_id": 1,
    "block_index": 1,
    "pdf_url": "http://localhost:8000/api/blockchain/certificates/CERT-2025-123456/download",
    "qr_code_url": "http://localhost:8000/qrcodes/cert_CERT-2025-123456.png",
    "verification_url": "https://educhain.com/blockchain/certificates/CERT-2025-123456/verify",
    "created_at": "..."
}
```

**验证点**：
- [ ] certificate_id格式为CERT-YYYY-NNNNNN
- [ ] pdf_url可访问
- [ ] qr_code_url可访问

---

#### TC-012: 下载证书PDF

**前置条件**：已完成TC-011生成证书

**测试步骤**：
```bash
curl -o certificate.pdf "http://localhost:8000/api/blockchain/certificates/CERT-2025-123456/download"
```

**预期结果**：
- 成功下载PDF文件
- 文件大小大于0

**验证点**：
- [ ] 返回Content-Type: application/pdf
- [ ] 文件可正常打开

---

#### TC-013: 验证证书有效性

**前置条件**：已完成TC-011生成证书

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/certificates/CERT-2025-123456/verify"
```

**预期结果**：
```json
{
    "valid": true,
    "certificate_id": "CERT-2025-123456",
    "message": "Certificate is valid",
    "verification_time": "..."
}
```

---

#### TC-014: 验证不存在的证书

**测试步骤**：
```bash
curl "http://localhost:8000/api/blockchain/certificates/CERT-0000-000000/verify"
```

**预期结果**：
```json
{
    "valid": false,
    "certificate_id": "CERT-0000-000000",
    "message": "Certificate not found"
}
```

---

#### TC-015: 为未存证内容生成证书

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certificates" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 99999,
    "knowledge_title": "不存在的知识",
    "user_id": 1,
    "user_name": "测试用户"
  }'
```

**预期结果**：
```json
{
    "detail": "No certification found for knowledge_id 99999"
}
```

**验证点**：
- [ ] 返回状态码404

---

### 2.5 健康检查测试

#### TC-016: 服务健康检查

**测试步骤**：
```bash
curl "http://localhost:8000/health"
```

**预期结果**：
```json
{
    "status": "healthy",
    "chain_length": 2,
    "is_valid": true
}
```

**验证点**：
- [ ] status为"healthy"
- [ ] is_valid为true

---

## 三、链完整性测试

### 3.1 链验证测试

#### TC-017: 验证区块链完整性

**测试目的**：验证区块链的哈希链接正确

**测试步骤**：
1. 获取区块链信息
2. 检查is_valid字段

```bash
curl "http://localhost:8000/api/blockchain/chain"
```

**预期结果**：
- is_valid为true

---

#### TC-018: 多次存证后验证链完整性

**测试步骤**：
```bash
# 1. 执行多次存证
for i in {1..10}; do
  curl -X POST "http://localhost:8000/api/blockchain/certify" \
    -H "Content-Type: application/json" \
    -d "{
      \"type\": \"KNOWLEDGE_CERT\",
      \"knowledge_id\": $((100+i)),
      \"user_id\": 1,
      \"content_hash\": \"$(echo -n "content$i" | sha256sum | cut -d' ' -f1)\"
    }"
done

# 2. 验证链完整性
curl "http://localhost:8000/api/blockchain/chain"
```

**预期结果**：
- 所有存证成功
- is_valid为true

---

## 四、性能测试

### 4.1 并发存证测试

#### TC-019: 并发存证性能

**测试目的**：测试系统在并发请求下的表现

**测试工具**：Apache Bench (ab)

**测试步骤**：
```bash
# 创建请求文件
echo '{
  "type": "KNOWLEDGE_CERT",
  "knowledge_id": 1000,
  "user_id": 1,
  "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
}' > request.json

# 执行并发测试（100个请求，10个并发）
ab -n 100 -c 10 -p request.json -T application/json \
  http://localhost:8000/api/blockchain/certify
```

**预期结果**：
- 请求成功率 > 99%
- 平均响应时间 < 500ms

---

### 4.2 查询性能测试

#### TC-020: 查询响应时间

**测试步骤**：
```bash
# 测试查询响应时间
time curl "http://localhost:8000/api/blockchain/chain"
time curl "http://localhost:8000/api/blockchain/stats"
```

**预期结果**：
- 响应时间 < 100ms

---

## 五、安全测试

### 5.1 输入验证测试

#### TC-021: SQL注入测试

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": "1; DROP TABLE blocks;--",
    "user_id": 1,
    "content_hash": "test"
  }'
```

**预期结果**：
- 返回验证错误
- 数据库未受影响

---

#### TC-022: XSS测试

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1,
    "user_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
    "metadata": {"title": "<script>alert(1)</script>"}
  }'
```

**预期结果**：
- 数据被正常存储（作为字符串）
- 不会执行脚本

---

### 5.2 边界测试

#### TC-023: 超长内容哈希

**测试步骤**：
```bash
curl -X POST "http://localhost:8000/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1,
    "user_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }'
```

**预期结果**：
- 返回验证错误或正常处理

---

## 六、测试结果汇总

### 6.1 测试用例统计

| 类别 | 用例数 | 通过 | 失败 | 通过率 |
|------|--------|------|------|--------|
| 存证功能 | 2 | - | - | - |
| 验证功能 | 3 | - | - | - |
| 查询功能 | 5 | - | - | - |
| 证书功能 | 5 | - | - | - |
| 健康检查 | 1 | - | - | - |
| 链完整性 | 2 | - | - | - |
| 性能测试 | 2 | - | - | - |
| 安全测试 | 3 | - | - | - |
| **总计** | **23** | - | - | - |

### 6.2 测试结论

- [ ] 所有功能测试通过
- [ ] 性能满足要求
- [ ] 安全测试无重大漏洞
- [ ] 系统可以上线

---

## 附录：测试脚本

### 完整测试脚本

```bash
#!/bin/bash
# test_blockchain.sh

BASE_URL="http://localhost:8000"

echo "=== 区块链服务测试 ==="

# 1. 健康检查
echo -e "\n[1] 健康检查"
curl -s "$BASE_URL/health" | jq .

# 2. 存证测试
echo -e "\n[2] 存证测试"
CERTIFY_RESULT=$(curl -s -X POST "$BASE_URL/api/blockchain/certify" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "KNOWLEDGE_CERT",
    "knowledge_id": 1,
    "user_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }')
echo $CERTIFY_RESULT | jq .

# 3. 验证测试
echo -e "\n[3] 验证测试"
curl -s -X POST "$BASE_URL/api/blockchain/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "content_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  }' | jq .

# 4. 获取链信息
echo -e "\n[4] 获取链信息"
curl -s "$BASE_URL/api/blockchain/chain" | jq .

# 5. 获取统计
echo -e "\n[5] 获取统计"
curl -s "$BASE_URL/api/blockchain/stats" | jq .

# 6. 生成证书
echo -e "\n[6] 生成证书"
curl -s -X POST "$BASE_URL/api/blockchain/certificates" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": 1,
    "knowledge_title": "测试知识",
    "user_id": 1,
    "user_name": "测试用户"
  }' | jq .

echo -e "\n=== 测试完成 ==="
```

---

**文档结束**
