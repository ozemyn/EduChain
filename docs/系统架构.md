# EduChain 系统架构

## 1. 整体架构

### 1.1 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │   Web端     │  │   移动端    │  │  第三方应用  │                 │
│  │  (React)    │  │  (Future)   │  │   (API)     │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           网关层                                     │
│                    Nginx (负载均衡/反向代理)                         │
└─────────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌───────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│    后端服务        │ │   静态资源       │ │   文件服务       │
│  (Spring Boot)    │ │   (CDN)         │ │   (Uploads)     │
│    Port: 8080     │ │                 │ │                 │
└───────────────────┘ └─────────────────┘ └─────────────────┘
         │
         ├──────────────────────────────────┐
         ▼                                  ▼
┌─────────────────┐              ┌─────────────────────┐
│   数据存储层     │              │    区块链服务        │
│  ┌───────────┐  │              │   (Python/FastAPI)  │
│  │  MySQL    │  │              │     Port: 8000      │
│  │  8.0      │  │              └─────────────────────┘
│  └───────────┘  │                        │
│  ┌───────────┐  │                        ▼
│  │  Redis    │  │              ┌─────────────────────┐
│  │  7.0      │  │              │   区块链数据库       │
│  └───────────┘  │              │   (SQLite)          │
└─────────────────┘              └─────────────────────┘
```

### 1.2 服务清单

| 服务 | 技术栈 | 端口 | 说明 |
|------|--------|------|------|
| 前端应用 | React 19 + TypeScript | 5173 | 用户界面 |
| 后端API | Spring Boot 3.2 | 8080 | 业务逻辑 |
| 区块链服务 | Python + FastAPI | 8000 | 存证服务 |
| MySQL | MySQL 8.0 | 3306 | 主数据库 |
| Redis | Redis 7.0 | 6379 | 缓存/限流 |

## 2. 技术选型

### 2.1 后端技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 框架 | Spring Boot | 3.2.0 | 企业级框架，生态完善 |
| 语言 | Java | 21 | LTS版本，性能优异 |
| 安全 | Spring Security | 6.x | 成熟的安全框架 |
| ORM | Spring Data JPA | 3.x | 简化数据访问 |
| 缓存 | Redis | 7.0 | 高性能缓存 |
| 认证 | JWT | 0.11.5 | 无状态认证 |
| 文档 | SpringDoc | 2.5.0 | OpenAPI 3.0 |

### 2.2 前端技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 框架 | React | 19 | 组件化开发 |
| 语言 | TypeScript | 5.x | 类型安全 |
| 路由 | React Router | 7.x | 声明式路由 |
| UI库 | Ant Design | 6.0 | 企业级组件 |
| 构建 | Vite | 6.3 | 快速构建 |
| HTTP | Axios | 1.x | HTTP客户端 |
| Mock | MSW | 2.x | API模拟 |

### 2.3 区块链技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| 框架 | FastAPI | 高性能Python框架 |
| 哈希 | SHA-256 | 安全哈希算法 |
| 数据结构 | Merkle Tree | 交易验证 |
| 存储 | SQLite | 轻量级数据库 |
| 证书 | ReportLab | PDF生成 |

## 3. 后端架构

### 3.1 分层架构

```
┌────────────────────────────────────────────────────────────┐
│                    Controller 控制层                        │
│              接收请求 → 参数校验 → 调用服务 → 返回响应        │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                    Service 服务层                           │
│              业务逻辑 → 事务管理 → 服务编排                  │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                   Repository 数据访问层                     │
│              JPA接口 → 自定义查询 → 数据操作                 │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                    Entity 实体层                            │
│              JPA实体 → 数据库映射 → 关联关系                 │
└────────────────────────────────────────────────────────────┘
```

### 3.2 模块划分

| 模块 | 包名 | 说明 |
|------|------|------|
| 控制器 | controller | 21个REST控制器 |
| 服务 | service | 22个业务服务 |
| 实体 | entity | 21个JPA实体 |
| 仓库 | repository | 21个数据仓库 |
| DTO | dto | 47个数据传输对象 |
| 配置 | config | 13个配置类 |
| 工具 | util | 13个工具类 |
| 异常 | exception | 6个异常类 |

### 3.3 安全架构

```
请求 → Nginx → JwtAuthenticationFilter → SecurityConfig → Controller
                      │
                      ▼
              ┌───────────────┐
              │  JWT验证      │
              │  - 解析Token  │
              │  - 验证签名   │
              │  - 检查过期   │
              └───────────────┘
                      │
                      ▼
              ┌───────────────┐
              │  权限检查      │
              │  - RBAC       │
              │  - @PreAuth   │
              └───────────────┘
                      │
                      ▼
              ┌───────────────┐
              │  限流检查      │
              │  - IP限流     │
              │  - 用户限流   │
              └───────────────┘
```

## 4. 前端架构

### 4.1 目录结构

```
frontend/src/
├── components/          # 通用组件
│   ├── common/          # 基础组件
│   ├── layout/          # 布局组件
│   └── business/        # 业务组件
├── pages/               # 页面组件
│   ├── home/            # 首页
│   ├── knowledge/       # 知识模块
│   ├── user/            # 用户模块
│   └── admin/           # 管理后台
├── services/            # API服务
├── hooks/               # 自定义Hooks
├── store/               # 状态管理
├── utils/               # 工具函数
├── styles/              # 样式文件
└── mock/                # Mock数据
```

### 4.2 状态管理

```
┌─────────────────────────────────────────────────────────┐
│                    React Context                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ AuthContext │  │ ThemeContext│  │ UserContext │     │
│  │  用户认证   │  │   主题切换  │  │   用户信息  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    Local State                           │
│              useState / useReducer                       │
│                    组件内部状态                           │
└─────────────────────────────────────────────────────────┘
```

## 5. 区块链架构

### 5.1 区块结构

```
┌─────────────────────────────────────────────────────────┐
│                      Block                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │  index: 区块索引                                  │   │
│  │  timestamp: 时间戳                               │   │
│  │  previous_hash: 前一区块哈希                     │   │
│  │  hash: 当前区块哈希                              │   │
│  │  merkle_root: Merkle根                          │   │
│  │  transactions: 交易列表                          │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 5.2 交易结构

```json
{
  "knowledge_id": 12345,
  "user_id": 1,
  "type": "CREATE",
  "content_hash": "sha256:abc123...",
  "timestamp": "2024-01-01T00:00:00Z",
  "metadata": {
    "title": "知识标题",
    "version": 1
  }
}
```

### 5.3 存证流程

```
用户发布内容 → 后端服务 → 计算内容哈希 → 调用区块链API
                                              │
                                              ▼
                                      创建交易记录
                                              │
                                              ▼
                                      打包到区块
                                              │
                                              ▼
                                      返回存证结果
```

## 6. 数据流

### 6.1 请求流程

```
用户操作 → 前端组件 → API服务 → HTTP请求
                                    │
                                    ▼
                              Nginx代理
                                    │
                                    ▼
                              后端Controller
                                    │
                                    ▼
                              Service处理
                                    │
                                    ▼
                              Repository查询
                                    │
                                    ▼
                              MySQL/Redis
                                    │
                                    ▼
                              返回响应数据
```

### 6.2 认证流程

```
登录请求 → 验证凭证 → 生成JWT → 返回Token
                                    │
                                    ▼
后续请求 → 携带Token → JWT过滤器 → 验证Token → 设置认证信息
```

## 7. 部署架构

### 7.1 开发环境

```
┌─────────────────────────────────────────────────────────┐
│                    开发机器                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │ 前端    │  │ 后端    │  │ MySQL   │  │ Redis   │   │
│  │ :5173   │  │ :8080   │  │ :3306   │  │ :6379   │   │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 7.2 生产环境

```
┌─────────────────────────────────────────────────────────┐
│                      负载均衡                            │
│                    (Nginx/云LB)                         │
└─────────────────────────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  后端实例1  │  │  后端实例2  │  │  后端实例N  │
└─────────────┘  └─────────────┘  └─────────────┘
          │               │               │
          └───────────────┼───────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      数据层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ MySQL主从   │  │ Redis集群   │  │ 文件存储    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

## 8. 扩展性设计

### 8.1 水平扩展

- 后端服务无状态，支持多实例部署
- Redis集群支持缓存扩展
- MySQL主从复制支持读写分离

### 8.2 功能扩展

- 模块化设计，新功能独立开发
- 插件化架构，支持功能插拔
- API版本控制，兼容升级

### 8.3 技术扩展

- 可接入Elasticsearch增强搜索
- 可接入消息队列实现异步处理
- 可接入公链实现跨链存证
