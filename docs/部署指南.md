# EduChain 部署指南

## 1. 部署方式

EduChain 支持以下部署方式：

| 方式 | 适用场景 | 复杂度 |
|------|----------|--------|
| 手动部署 | 学习/测试 | 低 |
| Docker部署 | 开发/测试 | 中 |
| Docker Compose | 生产环境 | 中 |
| Kubernetes | 大规模生产 | 高 |

## 2. 手动部署

### 2.1 环境要求

- JDK 21+
- Node.js 18+
- Python 3.9+
- MySQL 8.0+
- Redis 7.0+
- Nginx (可选)

### 2.2 后端部署

```bash
# 构建
mvn clean package -DskipTests

# 启动
java -jar target/EduChain-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --server.port=8080
```

### 2.3 前端部署

```bash
cd frontend

# 构建
npm run build

# 部署到 Nginx
cp -r dist/* /var/www/educhain/
```

### 2.4 区块链服务部署

```bash
cd blockchain-service

# 安装依赖
pip install -r requirements.txt

# 启动
python main.py
```

## 3. Docker 部署

### 3.1 后端 Dockerfile

```dockerfile
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY target/EduChain-0.0.1-SNAPSHOT.jar app.jar
ENV JAVA_OPTS="-Xms512m -Xmx1024m"
EXPOSE 8080
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 3.2 前端 Dockerfile

```dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
```

### 3.3 构建镜像

```bash
# 后端
docker build -t educhain-backend:latest .

# 前端
docker build -t educhain-frontend:latest -f frontend/Dockerfile .

# 区块链
docker build -t educhain-blockchain:latest blockchain-service/
```

## 4. Docker Compose 部署

### 4.1 docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: educhain-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: educhain_db
      MYSQL_USER: educhain
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-educhain123}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/database_schema.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - educhain-network

  redis:
    image: redis:7-alpine
    container_name: educhain-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - educhain-network

  backend:
    image: educhain-backend:latest
    container_name: educhain-backend
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_URL=jdbc:mysql://mysql:3306/educhain_db
      - DB_USERNAME=educhain
      - DB_PASSWORD=${MYSQL_PASSWORD:-educhain123}
      - REDIS_HOST=redis
      - JWT_SECRET=${JWT_SECRET:-your-secret-key}
      - BLOCKCHAIN_SERVICE_URL=http://blockchain:8000
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - educhain-network

  blockchain:
    image: educhain-blockchain:latest
    container_name: educhain-blockchain
    ports:
      - "8000:8000"
    volumes:
      - blockchain_data:/app/data
    networks:
      - educhain-network

  frontend:
    image: educhain-frontend:latest
    container_name: educhain-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - educhain-network

volumes:
  mysql_data:
  redis_data:
  blockchain_data:

networks:
  educhain-network:
    driver: bridge
```

### 4.2 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 5. Nginx 配置

### 5.1 nginx.conf

```nginx
upstream backend {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name educhain.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name educhain.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # 前端静态文件
    location / {
        root /var/www/educhain;
        try_files $uri $uri/ /index.html;
        expires 7d;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传
    location /uploads/ {
        alias /var/www/educhain/uploads/;
        expires 30d;
    }

    client_max_body_size 50M;
}
```

## 6. 环境变量

### 6.1 必需变量

| 变量 | 说明 | 示例 |
|------|------|------|
| DB_URL | 数据库URL | jdbc:mysql://localhost:3306/educhain_db |
| DB_USERNAME | 数据库用户名 | educhain |
| DB_PASSWORD | 数据库密码 | your_password |
| REDIS_HOST | Redis主机 | localhost |
| JWT_SECRET | JWT密钥 | your-secret-key |

### 6.2 可选变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| SERVER_PORT | 服务端口 | 8080 |
| REDIS_PORT | Redis端口 | 6379 |
| BLOCKCHAIN_SERVICE_URL | 区块链服务地址 | http://localhost:8000 |

## 7. 生产环境配置

### 7.1 JVM 参数

```bash
JAVA_OPTS="-Xms1g -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/educhain/ \
  -Djava.security.egd=file:/dev/./urandom"
```

### 7.2 数据库优化

```sql
-- MySQL 配置优化
SET GLOBAL innodb_buffer_pool_size = 1G;
SET GLOBAL max_connections = 500;
SET GLOBAL query_cache_size = 64M;
```

### 7.3 Redis 配置

```conf
# redis.conf
maxmemory 512mb
maxmemory-policy allkeys-lru
appendonly yes
```

## 8. 监控与日志

### 8.1 健康检查

```bash
# 后端健康检查
curl http://localhost:8080/api/actuator/health

# 区块链服务健康检查
curl http://localhost:8000/health
```

### 8.2 日志配置

```yaml
logging:
  file:
    name: /var/log/educhain/app.log
    max-size: 100MB
    max-history: 30
  level:
    root: WARN
    com.example.educhain: INFO
```

### 8.3 日志轮转

```
/var/log/educhain/*.log {
    daily
    rotate 30
    compress
    missingok
    notifempty
}
```

## 9. 备份策略

### 9.1 数据库备份

```bash
#!/bin/bash
DATE=$(date +%Y%m%d)
mysqldump -u educhain -p educhain_db | gzip > /backup/educhain_$DATE.sql.gz
find /backup -name "*.sql.gz" -mtime +30 -delete
```

### 9.2 定时任务

```bash
# crontab -e
0 2 * * * /opt/scripts/backup.sh
```

## 10. 安全配置

### 10.1 防火墙

```bash
# 只开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw enable
```

### 10.2 SSL 证书

```bash
# 使用 Let's Encrypt
certbot --nginx -d educhain.example.com
```

## 11. 故障排查

| 问题 | 检查项 |
|------|--------|
| 服务无法启动 | 检查端口占用、日志输出 |
| 数据库连接失败 | 检查连接参数、网络连通性 |
| 内存溢出 | 调整JVM参数、检查内存泄漏 |
| 响应缓慢 | 检查数据库慢查询、Redis连接 |
