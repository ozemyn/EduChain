# EduChain 实体类文档

## 1. 概述

本文档详细描述 EduChain 系统中的 21 个 JPA 实体类，包括字段定义、关联关系、索引设计等。

## 2. 实体类总览

| 实体类 | 数据库表 | 说明 |
|--------|----------|------|
| User | users | 用户信息 |
| KnowledgeItem | knowledge_items | 知识内容 |
| Category | categories | 分类 |
| Tag | tags | 标签 |
| Comment | comments | 评论 |
| UserInteraction | user_interactions | 用户互动 |
| UserFollow | user_follows | 用户关注 |
| Notification | notifications | 通知 |
| KnowledgeStats | knowledge_stats | 知识统计 |
| KnowledgeVersion | knowledge_versions | 知识版本 |
| UserStats | user_stats | 用户统计 |
| UserAchievement | user_achievements | 用户成就 |
| SearchHistory | search_history | 搜索历史 |
| SearchIndex | search_index | 搜索索引 |
| HotKeyword | hot_keywords | 热门关键词 |
| FileUpload | file_uploads | 文件上传 |
| ExternalContent | external_contents | 外部内容 |
| ExternalSource | external_sources | 外部来源 |
| SystemLog | system_logs | 系统日志 |
| AdminLog | admin_logs | 管理员日志 |

---

## 3. 核心实体详解

### 3.1 User (用户实体)

**表名**: `users`

**描述**: 存储用户基本信息，是系统的核心实体之一。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 用户ID |
| username | String(50) | UNIQUE, NOT NULL | 用户名 |
| email | String(100) | UNIQUE, NOT NULL | 邮箱 |
| passwordHash | String | NOT NULL | 密码哈希 |
| role | UserRole | NOT NULL | 用户角色 |
| fullName | String(100) | - | 真实姓名 |
| avatarUrl | String(500) | - | 头像URL |
| school | String(100) | - | 学校 |
| level | Integer | NOT NULL, DEFAULT 1 | 用户等级 |
| bio | TEXT | - | 个人简介 |
| status | Integer | NOT NULL, DEFAULT 1 | 状态(1正常,0禁用) |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |
| updatedAt | LocalDateTime | NOT NULL | 更新时间 |


#### 索引

```java
@Index(name = "idx_username", columnList = "username")
@Index(name = "idx_email", columnList = "email")
@Index(name = "idx_status", columnList = "status")
```

#### 枚举类型

```java
public enum UserRole {
    LEARNER("学习者"),
    ADMIN("管理员");
}
```

#### 验证规则

- 用户名: 3-50字符，唯一
- 邮箱: 有效邮箱格式，唯一
- 密码: 不能为空

---

### 3.2 KnowledgeItem (知识内容实体)

**表名**: `knowledge_items`

**描述**: 存储知识内容信息，支持多种内容类型和版本管理。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 知识ID |
| shareCode | String(32) | UNIQUE, NOT NULL | 分享码 |
| title | String(200) | NOT NULL | 标题 |
| content | LONGTEXT | - | 内容 |
| type | ContentType | NOT NULL | 内容类型 |
| mediaUrlsJson | JSON | - | 媒体URL列表 |
| linkUrl | String(500) | - | 链接URL |
| uploaderId | Long | NOT NULL, FK | 上传者ID |
| categoryId | Long | NOT NULL, FK | 分类ID |
| tags | String(500) | - | 标签(逗号分隔) |
| status | Integer | NOT NULL, DEFAULT 1 | 状态 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |
| updatedAt | LocalDateTime | NOT NULL | 更新时间 |

#### 索引

```java
@Index(name = "idx_share_code", columnList = "share_code")
@Index(name = "idx_title", columnList = "title")
@Index(name = "idx_uploader_id", columnList = "uploader_id")
@Index(name = "idx_category_id", columnList = "category_id")
@Index(name = "idx_type", columnList = "type")
@Index(name = "idx_status", columnList = "status")
@Index(name = "idx_created_at", columnList = "created_at")
@Index(name = "idx_tags", columnList = "tags")
```

#### 枚举类型

```java
public enum ContentType {
    TEXT("文本"),
    IMAGE("图片"),
    VIDEO("视频"),
    DOCUMENT("文档"),
    LINK("链接"),
    MIXED("混合");
}
```

#### 状态说明

| 状态码 | 说明 |
|--------|------|
| 0 | 已删除 |
| 1 | 正常/已发布 |
| 2 | 草稿 |

#### 关联关系

```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "uploader_id")
private User uploader;

@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "category_id")
private Category category;
```

---

### 3.3 Category (分类实体)

**表名**: `categories`

**描述**: 存储知识分类信息，支持树形层级结构。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 分类ID |
| name | String(100) | UNIQUE, NOT NULL | 分类名称 |
| description | TEXT | - | 分类描述 |
| parentId | Long | FK | 父分类ID |
| sortOrder | Integer | NOT NULL, DEFAULT 0 | 排序顺序 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |

#### 索引

```java
@Index(name = "idx_name", columnList = "name")
@Index(name = "idx_parent_id", columnList = "parent_id")
@Index(name = "idx_sort_order", columnList = "sort_order")
```

#### 关联关系

```java
// 父分类
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "parent_id")
private Category parent;

// 子分类列表
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
private List<Category> children;
```

---

### 3.4 Tag (标签实体)

**表名**: `tags`

**描述**: 存储标签信息，支持使用统计和分类。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 标签ID |
| name | String(50) | UNIQUE, NOT NULL | 标签名称 |
| description | String(200) | - | 标签描述 |
| usageCount | Long | NOT NULL, DEFAULT 0 | 使用次数 |
| category | String(50) | - | 标签分类 |
| color | String(20) | - | 标签颜色 |
| status | Integer | NOT NULL, DEFAULT 1 | 状态 |
| creatorId | Long | FK | 创建者ID |
| lastUsedAt | LocalDateTime | - | 最后使用时间 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |
| updatedAt | LocalDateTime | NOT NULL | 更新时间 |

#### 索引

```java
@Index(name = "idx_name", columnList = "name", unique = true)
@Index(name = "idx_usage_count", columnList = "usage_count")
@Index(name = "idx_category", columnList = "category")
@Index(name = "idx_status", columnList = "status")
```

#### 业务方法

```java
// 增加使用次数
public void incrementUsageCount() {
    this.usageCount++;
    this.lastUsedAt = LocalDateTime.now();
}

// 检查是否热门
public boolean isPopular(long usageThreshold) {
    return this.usageCount >= usageThreshold;
}
```

---

### 3.5 Comment (评论实体)

**表名**: `comments`

**描述**: 存储评论信息，支持层级回复结构。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 评论ID |
| knowledgeId | Long | NOT NULL, FK | 知识内容ID |
| userId | Long | NOT NULL, FK | 用户ID |
| parentId | Long | FK | 父评论ID |
| content | TEXT | NOT NULL | 评论内容 |
| status | Integer | NOT NULL, DEFAULT 1 | 状态 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |

#### 索引

```java
@Index(name = "idx_knowledge_id", columnList = "knowledge_id")
@Index(name = "idx_user_id", columnList = "user_id")
@Index(name = "idx_parent_id", columnList = "parent_id")
@Index(name = "idx_status", columnList = "status")
@Index(name = "idx_created_at", columnList = "created_at")
```

#### 状态说明

| 状态码 | 说明 |
|--------|------|
| 0 | 已删除 |
| 1 | 正常 |
| 2 | 待审核 |

#### 关联关系

```java
// 所属知识内容
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "knowledge_id")
private KnowledgeItem knowledgeItem;

// 评论用户
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "user_id")
private User user;

// 父评论
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "parent_id")
private Comment parent;

// 回复列表
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
private List<Comment> replies;
```

---

### 3.6 UserInteraction (用户互动实体)

**表名**: `user_interactions`

**描述**: 存储用户与知识内容的互动记录（点赞、收藏、浏览）。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 互动ID |
| knowledgeId | Long | NOT NULL, FK | 知识内容ID |
| userId | Long | NOT NULL, FK | 用户ID |
| interactionType | InteractionType | NOT NULL | 互动类型 |
| ipAddress | String(45) | - | IP地址 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |

#### 唯一约束

```java
@UniqueConstraint(
    name = "uk_user_knowledge_interaction",
    columnNames = {"user_id", "knowledge_id", "interaction_type"}
)
```

#### 枚举类型

```java
public enum InteractionType {
    LIKE("点赞"),
    FAVORITE("收藏"),
    VIEW("浏览");
}
```

---

### 3.7 UserFollow (用户关注实体)

**表名**: `user_follows`

**描述**: 存储用户之间的关注关系。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 关注ID |
| followerId | Long | NOT NULL, FK | 关注者ID |
| followingId | Long | NOT NULL, FK | 被关注者ID |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |

#### 唯一约束

```java
@UniqueConstraint(
    name = "uk_follower_following",
    columnNames = {"follower_id", "following_id"}
)
```

---

### 3.8 Notification (通知实体)

**表名**: `notifications`

**描述**: 存储用户通知信息。

#### 字段定义

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Long | PK, AUTO | 通知ID |
| userId | Long | NOT NULL, FK | 用户ID |
| type | NotificationType | NOT NULL | 通知类型 |
| title | String(200) | NOT NULL | 通知标题 |
| content | TEXT | NOT NULL | 通知内容 |
| relatedId | Long | - | 相关内容ID |
| relatedUserId | Long | - | 相关用户ID |
| isRead | Boolean | NOT NULL, DEFAULT false | 是否已读 |
| createdAt | LocalDateTime | NOT NULL | 创建时间 |

#### 枚举类型

```java
public enum NotificationType {
    LIKE("点赞通知"),
    COMMENT("评论通知"),
    REPLY("回复通知"),
    FOLLOW("关注通知"),
    SYSTEM("系统通知");
}
```

---

## 4. 统计实体

### 4.1 KnowledgeStats (知识统计实体)

**表名**: `knowledge_stats`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 统计ID |
| knowledgeId | Long | 知识内容ID |
| viewCount | Long | 浏览次数 |
| likeCount | Long | 点赞次数 |
| favoriteCount | Long | 收藏次数 |
| commentCount | Long | 评论次数 |
| shareCount | Long | 分享次数 |
| qualityScore | Double | 质量评分 |
| updatedAt | LocalDateTime | 更新时间 |

---

### 4.2 UserStats (用户统计实体)

**表名**: `user_stats`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 统计ID |
| userId | Long | 用户ID |
| totalKnowledge | Long | 发布知识数 |
| totalLikes | Long | 获得点赞数 |
| totalFavorites | Long | 获得收藏数 |
| totalViews | Long | 获得浏览数 |
| totalComments | Long | 获得评论数 |
| followers | Long | 粉丝数 |
| following | Long | 关注数 |
| experiencePoints | Long | 经验值 |
| updatedAt | LocalDateTime | 更新时间 |

---

## 5. 版本管理实体

### 5.1 KnowledgeVersion (知识版本实体)

**表名**: `knowledge_versions`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 版本ID |
| knowledgeId | Long | 知识内容ID |
| versionNumber | Integer | 版本号 |
| title | String | 标题 |
| content | TEXT | 内容 |
| tags | String | 标签 |
| changeSummary | String | 变更摘要 |
| editorId | Long | 编辑者ID |
| createdAt | LocalDateTime | 创建时间 |

---

## 6. 搜索相关实体

### 6.1 SearchHistory (搜索历史实体)

**表名**: `search_history`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 记录ID |
| userId | Long | 用户ID |
| keyword | String | 搜索关键词 |
| resultCount | Long | 结果数量 |
| categoryId | Long | 分类ID |
| createdAt | LocalDateTime | 搜索时间 |

---

### 6.2 HotKeyword (热门关键词实体)

**表名**: `hot_keywords`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 记录ID |
| keyword | String | 关键词 |
| searchCount | Long | 搜索次数 |
| clickCount | Long | 点击次数 |
| period | String | 统计周期 |
| rank | Integer | 排名 |
| trend | Double | 趋势值 |
| updatedAt | LocalDateTime | 更新时间 |

---

## 7. 文件上传实体

### 7.1 FileUpload (文件上传实体)

**表名**: `file_uploads`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 文件ID |
| fileName | String | 原始文件名 |
| storedName | String | 存储文件名 |
| filePath | String | 文件路径 |
| fileUrl | String | 访问URL |
| fileSize | Long | 文件大小(字节) |
| mimeType | String | MIME类型 |
| uploaderId | Long | 上传者ID |
| knowledgeId | Long | 关联知识ID |
| status | Integer | 状态 |
| createdAt | LocalDateTime | 上传时间 |

---

## 8. 日志实体

### 8.1 SystemLog (系统日志实体)

**表名**: `system_logs`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 日志ID |
| level | String | 日志级别 |
| logger | String | 日志来源 |
| message | TEXT | 日志消息 |
| exception | TEXT | 异常信息 |
| userId | Long | 用户ID |
| ipAddress | String | IP地址 |
| userAgent | String | 用户代理 |
| requestUrl | String | 请求URL |
| requestMethod | String | 请求方法 |
| createdAt | LocalDateTime | 创建时间 |

---

### 8.2 AdminLog (管理员日志实体)

**表名**: `admin_logs`

#### 字段定义

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 日志ID |
| adminId | Long | 管理员ID |
| adminUsername | String | 管理员用户名 |
| operation | String | 操作类型 |
| targetType | String | 目标类型 |
| targetId | Long | 目标ID |
| description | TEXT | 操作描述 |
| oldValue | TEXT | 旧值 |
| newValue | TEXT | 新值 |
| ipAddress | String | IP地址 |
| createdAt | LocalDateTime | 操作时间 |

---

## 9. 实体关系图

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│    User     │────▶│ KnowledgeItem   │◀────│  Category   │
│             │     │                 │     │             │
│  - id       │     │  - id           │     │  - id       │
│  - username │     │  - shareCode    │     │  - name     │
│  - email    │     │  - title        │     │  - parentId │
│  - role     │     │  - content      │     └─────────────┘
└─────────────┘     │  - uploaderId   │            │
       │            │  - categoryId   │            │
       │            └─────────────────┘            │
       │                    │                      │
       ▼                    ▼                      │
┌─────────────┐     ┌─────────────────┐           │
│  UserStats  │     │    Comment      │           │
│             │     │                 │           │
│  - userId   │     │  - knowledgeId  │           │
│  - likes    │     │  - userId       │           │
│  - views    │     │  - parentId     │           │
└─────────────┘     └─────────────────┘           │
       │                    │                      │
       │                    │                      │
       ▼                    ▼                      │
┌─────────────┐     ┌─────────────────┐           │
│ UserFollow  │     │ UserInteraction │           │
│             │     │                 │           │
│ - followerId│     │  - knowledgeId  │           │
│ - followingId     │  - userId       │           │
└─────────────┘     │  - type         │           │
                    └─────────────────┘           │
                           │                      │
                           ▼                      │
                    ┌─────────────────┐           │
                    │      Tag        │◀──────────┘
                    │                 │
                    │  - name         │
                    │  - usageCount   │
                    └─────────────────┘
```

---

## 10. JPA审计配置

所有实体都使用 JPA 审计功能自动管理时间戳：

```java
@EntityListeners(AuditingEntityListener.class)
public class Entity {
    
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
}
```

配置类：

```java
@Configuration
@EnableJpaAuditing
public class JpaAuditingConfig {
}
```

---

## 11. 总结

EduChain 系统共包含 21 个实体类，涵盖用户管理、知识内容、社交互动、搜索推荐、文件管理和系统日志等核心功能。实体设计遵循以下原则：

1. **规范命名**: 表名使用下划线命名，字段使用驼峰命名
2. **合理索引**: 为常用查询字段建立索引
3. **延迟加载**: 关联实体使用 LAZY 加载提升性能
4. **审计支持**: 自动记录创建和更新时间
5. **软删除**: 使用状态字段实现软删除
