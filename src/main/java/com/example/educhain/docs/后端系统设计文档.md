# EduChain 后端系统设计文档

## 1. 系统概述

### 1.1 项目背景

EduChain 是一个基于区块链技术的教育知识共享平台，后端系统负责提供完整的业务逻辑处理、数据持久化、安全认证和区块链存证等核心功能。

### 1.2 设计目标

- **高性能**: 支持高并发访问，响应时间 < 200ms
- **高可用**: 服务可用性 > 99.9%
- **安全性**: 完善的认证授权和数据保护机制
- **可扩展**: 模块化设计，易于功能扩展
- **可维护**: 清晰的代码结构和完善的文档

## 2. 技术架构

### 2.1 技术栈

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 核心框架 | Spring Boot | 3.2.0 | 应用框架 |
| 编程语言 | Java | 21 | LTS版本 |
| 安全框架 | Spring Security | 6.x | 认证授权 |
| 数据访问 | Spring Data JPA | 3.x | ORM框架 |
| 数据库 | MySQL | 8.0+ | 关系型数据库 |
| 缓存 | Redis | 7.0+ | 分布式缓存 |
| 认证 | JWT (jjwt) | 0.11.5 | 令牌认证 |
| 文档 | SpringDoc OpenAPI | 2.5.0 | API文档 |
| 工具库 | Lombok | - | 代码简化 |
| HTML解析 | Jsoup | 1.16.1 | 内容处理 |
| 版本对比 | Java Diff Utils | 4.12 | 版本差异 |

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
│              (Web前端 / 移动端 / 第三方应用)                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        网关层                                    │
│                   (Nginx / 负载均衡)                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Spring Boot 应用层                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Controller │  │   Filter    │  │   Aspect    │              │
│  │    控制器    │  │  过滤器链   │  │   切面      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Service 服务层                        │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │    │
│  │  │用户服务  │ │知识服务  │ │搜索服务  │ │区块链服务│   │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Repository 数据访问层                   │    │
│  │              (Spring Data JPA Repositories)              │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
         │                              │
         ▼                              ▼
┌─────────────────┐          ┌─────────────────┐
│     MySQL       │          │     Redis       │
│   (主数据库)     │          │   (缓存/限流)   │
└─────────────────┘          └─────────────────┘
         │
         ▼
┌─────────────────┐
│  区块链服务      │
│  (Python/FastAPI)│
└─────────────────┘
```

### 2.3 分层架构

```
┌────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation)                    │
│  Controller: 接收请求、参数校验、调用服务、返回响应          │
│  DTO: 数据传输对象，前后端数据交换格式                       │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                    业务层 (Business)                        │
│  Service: 业务逻辑处理、事务管理、服务编排                   │
│  ServiceImpl: 服务接口实现                                  │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access)                 │
│  Repository: JPA数据访问接口                                │
│  Entity: JPA实体类，映射数据库表                            │
└────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────┐
│                    基础设施层 (Infrastructure)              │
│  Config: 配置类                                             │
│  Util: 工具类                                               │
│  Exception: 异常处理                                        │
└────────────────────────────────────────────────────────────┘
```

## 3. 目录结构

```
src/main/java/com/example/educhain/
├── EduChainApplication.java          # Spring Boot 启动类
├── BlockchainServiceLauncher.java    # 区块链服务启动器
│
├── annotation/                        # 自定义注解
│   └── RateLimit.java                # 限流注解
│
├── aspect/                            # AOP切面
│   └── RateLimitAspect.java          # 限流切面实现
│
├── config/                            # 配置类 (13个)
│   ├── CacheConfig.java              # 缓存配置
│   ├── JacksonConfig.java            # JSON序列化配置
│   ├── JpaAuditingConfig.java        # JPA审计配置
│   ├── JwtAuthenticationEntryPoint.java  # JWT认证入口
│   ├── JwtAuthenticationFilter.java  # JWT过滤器
│   ├── LoggingAspect.java            # 日志切面
│   ├── RateLimitConfig.java          # 限流配置
│   ├── RateLimitProperties.java      # 限流属性
│   ├── RedisConfig.java              # Redis配置
│   ├── SecurityConfig.java           # 安全配置
│   ├── SwaggerConfig.java            # Swagger配置
│   └── WebMvcConfig.java             # Web MVC配置
│
├── controller/                        # 控制器 (21个)
│   ├── AuthController.java           # 认证控制器
│   ├── UserController.java           # 用户控制器
│   ├── KnowledgeItemController.java  # 知识内容控制器
│   ├── CategoryController.java       # 分类控制器
│   ├── TagController.java            # 标签控制器
│   ├── CommentController.java        # 评论控制器
│   ├── UserInteractionController.java # 用户互动控制器
│   ├── UserFollowController.java     # 用户关注控制器
│   ├── NotificationController.java   # 通知控制器
│   ├── SearchController.java         # 搜索控制器
│   ├── RecommendationController.java # 推荐控制器
│   ├── BlockchainController.java     # 区块链控制器
│   ├── FileUploadController.java     # 文件上传控制器
│   ├── AchievementController.java    # 成就控制器
│   ├── CommunityController.java      # 社区控制器
│   ├── ExternalContentController.java # 外部内容控制器
│   ├── StatisticsController.java     # 统计控制器
│   ├── LogController.java            # 日志控制器
│   ├── AdminController.java          # 管理员控制器
│   └── TestController.java           # 测试控制器
│
├── dto/                               # 数据传输对象 (47个)
│   ├── LoginRequest.java             # 登录请求
│   ├── LoginResponse.java            # 登录响应
│   ├── RegisterRequest.java          # 注册请求
│   ├── UserDTO.java                  # 用户DTO
│   ├── KnowledgeItemDTO.java         # 知识内容DTO
│   ├── CommentDTO.java               # 评论DTO
│   ├── SearchRequest.java            # 搜索请求
│   ├── SearchResultDTO.java          # 搜索结果DTO
│   └── ...                           # 其他47个DTO
│
├── entity/                            # 实体类 (21个)
│   ├── User.java                     # 用户实体
│   ├── KnowledgeItem.java            # 知识内容实体
│   ├── Category.java                 # 分类实体
│   ├── Tag.java                      # 标签实体
│   ├── Comment.java                  # 评论实体
│   ├── UserInteraction.java          # 用户互动实体
│   ├── UserFollow.java               # 用户关注实体
│   ├── Notification.java             # 通知实体
│   └── ...                           # 其他实体
│
├── enums/                             # 枚举类
│   └── RateLimitType.java            # 限流类型枚举
│
├── exception/                         # 异常处理
│   ├── BusinessException.java        # 业务异常
│   ├── DatabaseException.java        # 数据库异常
│   ├── RateLimitException.java       # 限流异常
│   ├── ValidationException.java      # 验证异常
│   └── GlobalExceptionHandler.java   # 全局异常处理器
│
├── repository/                        # 数据访问层 (21个)
│   ├── UserRepository.java           # 用户仓库
│   ├── KnowledgeItemRepository.java  # 知识内容仓库
│   └── ...                           # 其他仓库
│
├── service/                           # 服务层 (22个)
│   ├── UserService.java              # 用户服务接口
│   ├── KnowledgeItemService.java     # 知识服务接口
│   ├── impl/                         # 服务实现
│   │   ├── UserServiceImpl.java
│   │   └── ...
│   └── ...
│
└── util/                              # 工具类 (13个)
    ├── JwtUtil.java                  # JWT工具
    ├── PasswordUtil.java             # 密码工具
    ├── HashUtil.java                 # 哈希工具
    ├── RedisManager.java             # Redis管理器
    ├── RateLimiter.java              # 限流器
    ├── Result.java                   # 统一响应
    ├── SecurityUtils.java            # 安全工具
    ├── SnowflakeIdGenerator.java     # 雪花ID生成器
    └── ...
```

## 4. 核心模块设计

### 4.1 认证授权模块

#### 4.1.1 认证流程

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐
│  客户端  │────▶│ AuthController│────▶│ UserService │────▶│ Database│
└─────────┘     └─────────────┘     └─────────────┘     └─────────┘
     │                 │                    │                 │
     │  1. 登录请求    │                    │                 │
     │────────────────▶│                    │                 │
     │                 │  2. 验证用户       │                 │
     │                 │───────────────────▶│                 │
     │                 │                    │  3. 查询用户    │
     │                 │                    │────────────────▶│
     │                 │                    │  4. 返回用户    │
     │                 │                    │◀────────────────│
     │                 │  5. 验证密码       │                 │
     │                 │◀───────────────────│                 │
     │                 │  6. 生成JWT        │                 │
     │                 │───────────────────▶│                 │
     │  7. 返回Token   │                    │                 │
     │◀────────────────│                    │                 │
```

#### 4.1.2 JWT令牌结构

```json
{
  "header": {
    "alg": "HS512",
    "typ": "JWT"
  },
  "payload": {
    "sub": "username",
    "userId": 1,
    "role": "LEARNER",
    "iat": 1703001600,
    "exp": 1703088000
  },
  "signature": "..."
}
```

#### 4.1.3 安全配置

```java
// SecurityConfig.java 核心配置
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) {
    http
        .csrf(AbstractHttpConfigurer::disable)
        .cors(cors -> cors.configurationSource(corsConfigurationSource()))
        .sessionManagement(session -> 
            session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
        .authorizeHttpRequests(authz -> authz
            .requestMatchers("/auth/**").permitAll()
            .requestMatchers("/admin/**").hasRole("ADMIN")
            .anyRequest().authenticated())
        .addFilterBefore(jwtAuthenticationFilter, 
            UsernamePasswordAuthenticationFilter.class);
    return http.build();
}
```

### 4.2 知识内容模块

#### 4.2.1 内容类型

| 类型 | 枚举值 | 说明 |
|------|--------|------|
| 文本 | TEXT | 纯文本内容 |
| 图片 | IMAGE | 图片内容 |
| 视频 | VIDEO | 视频内容 |
| 文档 | DOCUMENT | 文档文件 |
| 链接 | LINK | 外部链接 |
| 混合 | MIXED | 多种类型混合 |

#### 4.2.2 内容状态

| 状态码 | 说明 |
|--------|------|
| 0 | 已删除 |
| 1 | 正常/已发布 |
| 2 | 草稿 |

#### 4.2.3 版本管理

系统支持知识内容的版本管理功能：

- 每次更新自动创建新版本
- 支持版本历史查询
- 支持版本差异对比
- 支持恢复到指定版本

### 4.3 搜索推荐模块

#### 4.3.1 搜索功能

- **全文搜索**: 基于关键词的内容搜索
- **高级搜索**: 多条件组合筛选
- **搜索建议**: 输入联想提示
- **热门关键词**: 热搜词排行
- **搜索历史**: 用户搜索记录

#### 4.3.2 推荐算法

| 推荐类型 | 算法 | 说明 |
|----------|------|------|
| 个性化推荐 | 协同过滤 | 基于用户行为 |
| 热门推荐 | 热度排序 | 基于浏览/点赞数 |
| 相似推荐 | 内容相似度 | 基于标签/分类 |
| 混合推荐 | 加权融合 | 多算法组合 |

### 4.4 区块链存证模块

#### 4.4.1 存证流程

```
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 用户发布 │────▶│ BlockchainService│────▶│ Python区块链服务│
│ 知识内容 │     │   (Java后端)     │     │   (FastAPI)     │
└─────────┘     └──────────────────┘     └─────────────────┘
     │                   │                        │
     │  1. 创建内容      │                        │
     │──────────────────▶│                        │
     │                   │  2. 计算内容哈希       │
     │                   │  3. 调用存证API        │
     │                   │───────────────────────▶│
     │                   │                        │  4. 创建交易
     │                   │                        │  5. 打包区块
     │                   │  6. 返回存证结果       │
     │                   │◀───────────────────────│
     │  7. 返回成功      │                        │
     │◀──────────────────│                        │
```

#### 4.4.2 存证数据结构

```json
{
  "knowledge_id": 12345,
  "user_id": 1,
  "content_hash": "sha256:abc123...",
  "type": "CREATE",
  "timestamp": "2024-12-18T10:00:00Z",
  "metadata": {
    "title": "知识标题",
    "version": 1
  }
}
```

## 5. 安全机制

### 5.1 认证机制

| 机制 | 实现 | 说明 |
|------|------|------|
| JWT认证 | JwtAuthenticationFilter | 无状态令牌认证 |
| 密码加密 | BCryptPasswordEncoder | 密码哈希存储 |
| 令牌刷新 | RefreshToken | 双令牌机制 |

### 5.2 授权机制

| 角色 | 权限 |
|------|------|
| LEARNER | 基础用户权限，可发布/评论/互动 |
| ADMIN | 管理员权限，可管理用户/内容/系统 |

### 5.3 限流机制

```java
@RateLimit(
    key = "auth:login",
    limit = 10,           // 限制次数
    timeWindow = 60,      // 时间窗口(秒)
    type = RateLimitType.IP,
    algorithm = "sliding_window"
)
```

支持的限流算法：
- **sliding_window**: 滑动窗口
- **token_bucket**: 令牌桶

### 5.4 CORS配置

```java
configuration.setAllowedOriginPatterns(Arrays.asList(
    "http://localhost:3000",
    "http://localhost:5173",
    "http://localhost:8080"
));
configuration.setAllowedMethods(Arrays.asList(
    "GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"
));
```

## 6. 数据库设计

### 6.1 核心表关系

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│    users    │────▶│ knowledge_items │◀────│  categories │
└─────────────┘     └─────────────────┘     └─────────────┘
       │                    │                      │
       │                    │                      │
       ▼                    ▼                      │
┌─────────────┐     ┌─────────────────┐           │
│ user_stats  │     │    comments     │           │
└─────────────┘     └─────────────────┘           │
       │                    │                      │
       │                    │                      │
       ▼                    ▼                      │
┌─────────────┐     ┌─────────────────┐           │
│user_follows │     │user_interactions│           │
└─────────────┘     └─────────────────┘           │
                           │                      │
                           ▼                      │
                    ┌─────────────────┐           │
                    │     tags        │◀──────────┘
                    └─────────────────┘
```

### 6.2 索引策略

每个实体类都定义了合适的数据库索引：

```java
@Table(name = "knowledge_items", indexes = {
    @Index(name = "idx_share_code", columnList = "share_code"),
    @Index(name = "idx_title", columnList = "title"),
    @Index(name = "idx_uploader_id", columnList = "uploader_id"),
    @Index(name = "idx_category_id", columnList = "category_id"),
    @Index(name = "idx_status", columnList = "status"),
    @Index(name = "idx_created_at", columnList = "created_at")
})
```

## 7. 缓存策略

### 7.1 Redis缓存应用

| 缓存项 | Key格式 | 过期时间 | 说明 |
|--------|---------|----------|------|
| 用户信息 | user:{id} | 30分钟 | 用户基本信息 |
| JWT令牌 | token:{userId} | 24小时 | 访问令牌 |
| 限流计数 | rate:{key}:{ip} | 动态 | 限流计数器 |
| 热门内容 | hot:knowledge | 5分钟 | 热门知识列表 |
| 搜索建议 | suggest:{prefix} | 10分钟 | 搜索联想 |

### 7.2 缓存配置

```java
@Bean
public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
    RedisCacheConfiguration config = RedisCacheConfiguration
        .defaultCacheConfig()
        .entryTtl(Duration.ofMinutes(30))
        .serializeKeysWith(...)
        .serializeValuesWith(...);
    return RedisCacheManager.builder(factory)
        .cacheDefaults(config)
        .build();
}
```

## 8. 日志与监控

### 8.1 日志配置

```yaml
logging:
  level:
    root: WARN
    com.example.educhain: INFO
    org.springframework.security: WARN
  pattern:
    console: "%d{HH:mm:ss} %-5level %logger{36} - %msg%n"
  file:
    name: logs/educhain.log
```

### 8.2 操作日志

通过AOP切面记录关键操作：

```java
@LoggingAspect.OperationLog(
    operation = "禁用用户", 
    description = "管理员禁用用户账户"
)
public void disableUser(...) { ... }
```

### 8.3 健康检查

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized
```

## 9. 异常处理

### 9.1 异常类型

| 异常类 | HTTP状态码 | 说明 |
|--------|------------|------|
| BusinessException | 400 | 业务逻辑异常 |
| ValidationException | 400 | 参数验证异常 |
| RateLimitException | 429 | 限流异常 |
| DatabaseException | 500 | 数据库异常 |

### 9.2 统一响应格式

```java
public class Result<T> {
    private int code;        // 状态码
    private String message;  // 消息
    private T data;          // 数据
    private String errorCode; // 错误码
}
```

成功响应示例：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}
```

错误响应示例：
```json
{
  "code": 400,
  "message": "用户名已存在",
  "errorCode": "USER_EXISTS"
}
```

## 10. 性能优化

### 10.1 数据库优化

- 合理的索引设计
- 分页查询避免全表扫描
- 延迟加载关联实体
- 批量操作减少数据库交互

### 10.2 缓存优化

- 热点数据缓存
- 缓存预热
- 缓存穿透防护
- 缓存雪崩防护

### 10.3 接口优化

- 限流保护
- 异步处理
- 响应压缩
- 连接池复用

## 11. 扩展性设计

### 11.1 模块化设计

- 服务接口与实现分离
- 依赖注入解耦
- 配置外部化

### 11.2 可扩展点

- 新增认证方式（OAuth2、LDAP等）
- 新增存储后端（OSS、S3等）
- 新增搜索引擎（Elasticsearch）
- 新增消息队列（RabbitMQ、Kafka）

## 12. 总结

EduChain后端系统采用现代化的Spring Boot 3.2技术栈，遵循分层架构设计原则，实现了完整的教育知识共享平台功能。系统具有良好的安全性、可扩展性和可维护性，适合作为毕业设计的后端实现参考。
