# EduChain 后端部署文档

## 1. 环境要求

### 1.1 硬件要求

| 环境 | CPU | 内存 | 磁盘 |
|------|-----|------|------|
| 开发环境 | 2核 | 4GB | 20GB |
| 测试环境 | 4核 | 8GB | 50GB |
| 生产环境 | 8核+ | 16GB+ | 100GB+ |

### 1.2 软件要求

| 软件 | 版本 | 说明 |
|------|------|------|
| JDK | 21+ | LTS版本 |
| Maven | 3.9+ | 构建工具 |
| MySQL | 8.0+ | 数据库 |
| Redis | 7.0+ | 缓存 |
| Python | 3.9+ | 区块链服务 |

### 1.3 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| Spring Boot | 8080 | 后端API服务 |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| 区块链服务 | 8000 | Python FastAPI |

---

## 2. 开发环境搭建

### 2.1 安装JDK 21

```bash
# macOS (Homebrew)
brew install openjdk@21

# Ubuntu/Debian
sudo apt install openjdk-21-jdk

# 验证安装
java -version
```

### 2.2 安装Maven

```bash
# macOS
brew install maven

# Ubuntu/Debian
sudo apt install maven

# 验证安装
mvn -version
```

### 2.3 安装MySQL

```bash
# macOS
brew install mysql
brew services start mysql

# Ubuntu/Debian
sudo apt install mysql-server
sudo systemctl start mysql
```

### 2.4 安装Redis

```bash
# macOS
brew install redis
brew services start redis

# Ubuntu/Debian
sudo apt install redis-server
sudo systemctl start redis
```

### 2.5 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE educhain_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权
CREATE USER 'educhain'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON educhain_db.* TO 'educhain'@'localhost';
FLUSH PRIVILEGES;
```

### 2.6 导入数据库脚本

```bash
mysql -u educhain -p educhain_db < db/database_schema.sql
```

---

## 3. 项目构建

### 3.1 克隆项目

```bash
git clone https://github.com/your-repo/educhain.git
cd educhain
```

### 3.2 配置文件

修改 `src/main/resources/application.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/educhain_db
    username: educhain
    password: your_password
  
  data:
    redis:
      host: localhost
      port: 6379

jwt:
  secret: your-jwt-secret-key-minimum-512-bits
  expiration: 86400000

blockchain:
  service:
    url: http://localhost:8000
```

### 3.3 构建项目

```bash
# 清理并构建
mvn clean package -DskipTests

# 运行测试
mvn test

# 构建并运行测试
mvn clean package
```

### 3.4 启动应用

```bash
# 开发环境
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 或直接运行JAR
java -jar target/EduChain-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev
```

### 3.5 验证启动

```bash
# 检查健康状态
curl http://localhost:8080/api/actuator/health

# 访问Swagger文档
open http://localhost:8080/api/swagger-ui.html
```

---

## 4. 生产环境部署

### 4.1 环境变量配置

```bash
# 数据库配置
export DB_URL=jdbc:mysql://db-host:3306/educhain_db
export DB_USERNAME=educhain
export DB_PASSWORD=secure_password

# Redis配置
export REDIS_HOST=redis-host
export REDIS_PORT=6379

# JWT配置
export JWT_SECRET=your-production-jwt-secret

# 区块链服务
export BLOCKCHAIN_SERVICE_URL=http://blockchain-host:8000
```

### 4.2 生产配置文件

创建 `application-prod.yml`:

```yaml
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

# 生产环境禁用Swagger
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false

logging:
  level:
    root: ERROR
    com.example.educhain: WARN
```

### 4.3 启动脚本

创建 `start.sh`:

```bash
#!/bin/bash

APP_NAME=EduChain
JAR_FILE=EduChain-0.0.1-SNAPSHOT.jar
LOG_FILE=logs/educhain.log
PID_FILE=educhain.pid

# JVM参数
JAVA_OPTS="-Xms512m -Xmx2048m"
JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC"
JAVA_OPTS="$JAVA_OPTS -XX:MaxGCPauseMillis=200"
JAVA_OPTS="$JAVA_OPTS -Djava.security.egd=file:/dev/./urandom"

# 启动应用
nohup java $JAVA_OPTS \
  -jar $JAR_FILE \
  --spring.profiles.active=prod \
  > $LOG_FILE 2>&1 &

echo $! > $PID_FILE
echo "$APP_NAME started with PID $(cat $PID_FILE)"
```

### 4.4 停止脚本

创建 `stop.sh`:

```bash
#!/bin/bash

PID_FILE=educhain.pid

if [ -f $PID_FILE ]; then
    PID=$(cat $PID_FILE)
    kill $PID
    rm $PID_FILE
    echo "Application stopped"
else
    echo "PID file not found"
fi
```

### 4.5 重启脚本

创建 `restart.sh`:

```bash
#!/bin/bash

./stop.sh
sleep 3
./start.sh
```

---

## 5. Docker部署

### 5.1 Dockerfile

```dockerfile
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

COPY target/EduChain-0.0.1-SNAPSHOT.jar app.jar

ENV JAVA_OPTS="-Xms512m -Xmx1024m"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 5.2 构建镜像

```bash
# 构建项目
mvn clean package -DskipTests

# 构建Docker镜像
docker build -t educhain-backend:latest .
```

### 5.3 Docker Compose

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: educhain_db
      MYSQL_USER: educhain
      MYSQL_PASSWORD: educhain_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/database_schema.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    image: educhain-backend:latest
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_URL=jdbc:mysql://mysql:3306/educhain_db
      - DB_USERNAME=educhain
      - DB_PASSWORD=educhain_password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=your-jwt-secret
      - BLOCKCHAIN_SERVICE_URL=http://blockchain:8000
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads

  blockchain:
    build: ./blockchain-service
    ports:
      - "8000:8000"
    volumes:
      - blockchain_data:/app/data

volumes:
  mysql_data:
  redis_data:
  blockchain_data:
```

### 5.4 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```

---

## 6. Nginx反向代理

### 6.1 Nginx配置

```nginx
upstream educhain_backend {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name api.educhain.cc;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.educhain.cc;
    
    # SSL证书
    ssl_certificate /etc/nginx/ssl/educhain.crt;
    ssl_certificate_key /etc/nginx/ssl/educhain.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    
    # 日志
    access_log /var/log/nginx/educhain_access.log;
    error_log /var/log/nginx/educhain_error.log;
    
    # 文件上传大小限制
    client_max_body_size 50M;
    
    # API代理
    location /api/ {
        proxy_pass http://educhain_backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态文件
    location /uploads/ {
        alias /var/www/educhain/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 健康检查
    location /health {
        proxy_pass http://educhain_backend/api/actuator/health;
    }
}
```

### 6.2 重载Nginx

```bash
# 测试配置
nginx -t

# 重载配置
nginx -s reload
```

---

## 7. 监控与日志

### 7.1 日志配置

```yaml
logging:
  level:
    root: WARN
    com.example.educhain: INFO
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{40} - %msg%n"
  file:
    name: logs/educhain.log
    max-size: 100MB
    max-history: 30
```

### 7.2 日志轮转

创建 `/etc/logrotate.d/educhain`:

```
/var/log/educhain/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 educhain educhain
    postrotate
        systemctl reload educhain
    endscript
}
```

### 7.3 健康检查

```bash
# 检查应用健康状态
curl http://localhost:8080/api/actuator/health

# 检查应用信息
curl http://localhost:8080/api/actuator/info

# 检查指标
curl http://localhost:8080/api/actuator/metrics
```

### 7.4 监控指标

通过 Actuator 暴露的指标：

| 端点 | 说明 |
|------|------|
| /actuator/health | 健康状态 |
| /actuator/info | 应用信息 |
| /actuator/metrics | 性能指标 |

---

## 8. 安全配置

### 8.1 防火墙配置

```bash
# 只开放必要端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable
```

### 8.2 数据库安全

```sql
-- 限制远程访问
CREATE USER 'educhain'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON educhain_db.* TO 'educhain'@'localhost';

-- 禁用root远程登录
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
FLUSH PRIVILEGES;
```

### 8.3 Redis安全

```bash
# redis.conf
requirepass your_redis_password
bind 127.0.0.1
```

### 8.4 JWT密钥

生产环境使用强密钥：

```bash
# 生成随机密钥
openssl rand -base64 64
```

---

## 9. 备份策略

### 9.1 数据库备份

```bash
#!/bin/bash
# backup_db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=/backup/mysql
MYSQL_USER=educhain
MYSQL_PASS=password
DATABASE=educhain_db

mkdir -p $BACKUP_DIR

mysqldump -u$MYSQL_USER -p$MYSQL_PASS $DATABASE | gzip > $BACKUP_DIR/educhain_$DATE.sql.gz

# 保留最近30天的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

### 9.2 定时备份

```bash
# 添加crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /opt/scripts/backup_db.sh
```

### 9.3 文件备份

```bash
#!/bin/bash
# backup_files.sh

DATE=$(date +%Y%m%d)
BACKUP_DIR=/backup/files
SOURCE_DIR=/var/www/educhain/uploads

tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz $SOURCE_DIR
```

---

## 10. 故障排查

### 10.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 启动失败 | 端口占用 | `lsof -i:8080` 检查端口 |
| 数据库连接失败 | 配置错误 | 检查数据库URL和凭证 |
| Redis连接失败 | 服务未启动 | `systemctl status redis` |
| JWT验证失败 | 密钥不一致 | 检查JWT配置 |
| 内存溢出 | JVM参数不当 | 调整-Xmx参数 |

### 10.2 日志分析

```bash
# 查看错误日志
grep -i error logs/educhain.log | tail -100

# 查看最近日志
tail -f logs/educhain.log

# 统计错误类型
grep -i exception logs/educhain.log | cut -d: -f1 | sort | uniq -c
```

### 10.3 性能分析

```bash
# 查看JVM状态
jstat -gc <pid> 1000

# 生成堆转储
jmap -dump:format=b,file=heap.hprof <pid>

# 查看线程状态
jstack <pid> > thread_dump.txt
```

---

## 11. 版本升级

### 11.1 升级步骤

1. 备份数据库和配置文件
2. 停止当前服务
3. 部署新版本JAR
4. 执行数据库迁移（如有）
5. 启动新版本服务
6. 验证功能正常
7. 清理旧版本文件

### 11.2 回滚方案

```bash
#!/bin/bash
# rollback.sh

# 停止当前服务
./stop.sh

# 恢复旧版本
cp backup/EduChain-old.jar EduChain-0.0.1-SNAPSHOT.jar

# 恢复数据库（如需要）
mysql -u educhain -p educhain_db < backup/educhain_backup.sql

# 启动服务
./start.sh
```

---

## 12. 总结

本文档涵盖了 EduChain 后端系统从开发到生产的完整部署流程，包括：

- 开发环境搭建
- 项目构建与配置
- 生产环境部署
- Docker容器化部署
- Nginx反向代理
- 监控与日志
- 安全配置
- 备份策略
- 故障排查
- 版本升级

遵循本文档可以确保系统的稳定运行和高效维护。
