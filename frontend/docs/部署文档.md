
# EduChain 前端部署文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | EduChain 前端 |
| 构建工具 | Vite 7.2.4 |
| 运行环境 | Node.js 18+ |

---

## 一、环境要求

### 1.1 开发环境

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Node.js | 18.0+ | JavaScript运行时 |
| npm | 9.0+ | 包管理器 |
| Git | 2.0+ | 版本控制 |

### 1.2 生产环境

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Nginx | 1.20+ | Web服务器 |
| Docker | 20.10+ | 容器化部署（可选） |

---

## 二、本地开发

### 2.1 克隆项目

```bash
git clone <repository-url>
cd frontend
```

### 2.2 安装依赖

```bash
npm install
```

### 2.3 启动开发服务器

```bash
# 标准开发模式（连接后端API）
npm run dev

# Mock模式（使用Mock数据）
npm run dev:mock
```

### 2.4 访问应用

- 开发服务器：http://localhost:3000
- API代理：http://localhost:3000/api → http://localhost:8080/api

---

## 三、构建部署

### 3.1 构建命令

```bash
# 生产构建
npm run build

# Mock版本构建
npm run build:mock

# 类型检查
npm run type-check

# 代码检查
npm run lint
```

### 3.2 构建产物

构建完成后，产物位于 `dist/` 目录：

```
dist/
├── index.html
├── assets/
│   ├── index-[hash].js
│   ├── index-[hash].css
│   └── ...
└── vite.svg
```

### 3.3 预览构建结果

```bash
npm run preview
```

---

## 四、环境变量配置

### 4.1 环境文件

| 文件 | 用途 |
|------|------|
| .env | 默认环境变量 |
| .env.development | 开发环境 |
| .env.production | 生产环境 |
| .env.mock | Mock模式 |

### 4.2 环境变量说明

```bash
# .env.development
VITE_API_BASE_URL=/api
VITE_APP_TITLE=EduChain - 开发环境

# .env.production
VITE_API_BASE_URL=https://api.educhain.cc
VITE_APP_TITLE=EduChain - 教育区块链平台

# .env.mock
VITE_API_BASE_URL=/api
VITE_APP_TITLE=EduChain - Mock模式
VITE_ENABLE_MOCK=true
```

### 4.3 使用环境变量

```typescript
// 在代码中使用
const apiBaseUrl = import.meta.env.VITE_API_BASE_URL;
const appTitle = import.meta.env.VITE_APP_TITLE;
```

---

## 五、Nginx部署

### 5.1 Nginx配置

```nginx
server {
    listen 80;
    server_name educhain.cc www.educhain.cc;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name educhain.cc www.educhain.cc;
    
    # SSL证书
    ssl_certificate /etc/nginx/ssl/educhain.cc.crt;
    ssl_certificate_key /etc/nginx/ssl/educhain.cc.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    
    # 静态文件根目录
    root /var/www/educhain/dist;
    index index.html;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml;
    
    # 静态资源缓存
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

### 5.2 部署步骤

```bash
# 1. 构建项目
npm run build

# 2. 上传到服务器
scp -r dist/* user@server:/var/www/educhain/dist/

# 3. 重启Nginx
sudo nginx -t
sudo systemctl reload nginx
```

---

## 六、Docker部署

### 6.1 Dockerfile

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建
RUN npm run build

# 运行阶段
FROM nginx:alpine

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 暴露端口
EXPOSE 80

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### 6.2 nginx.conf（Docker用）

```nginx
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    
    # 静态资源缓存
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # SPA路由
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 6.3 Docker命令

```bash
# 构建镜像
docker build -t educhain-frontend:latest .

# 运行容器
docker run -d \
  --name educhain-frontend \
  -p 80:80 \
  educhain-frontend:latest

# 查看日志
docker logs -f educhain-frontend

# 停止容器
docker stop educhain-frontend

# 删除容器
docker rm educhain-frontend
```

### 6.4 Docker Compose

```yaml
version: '3.8'

services:
  frontend:
    build: .
    container_name: educhain-frontend
    ports:
      - "80:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
```

```bash
# 启动
docker-compose up -d

# 停止
docker-compose down

# 重建
docker-compose up -d --build
```

---

## 七、Cloudflare Pages部署

### 7.1 部署命令

```bash
# 构建Mock版本并部署到Cloudflare Pages
npm run deploy:cf
```

### 7.2 配置说明

```bash
# package.json中的部署脚本
"deploy:cf": "npm run build:mock && wrangler pages deploy dist --project-name educhain-frontend-mock"
```

### 7.3 环境变量配置

在Cloudflare Pages控制台设置环境变量：
- `VITE_API_BASE_URL`: API地址
- `VITE_APP_TITLE`: 应用标题

---

## 八、CI/CD配置

### 8.1 GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy Frontend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Type check
        working-directory: frontend
        run: npm run type-check
      
      - name: Lint
        working-directory: frontend
        run: npm run lint
      
      - name: Build
        working-directory: frontend
        run: npm run build
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: frontend/dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: dist
          path: dist
      
      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "dist/*"
          target: "/var/www/educhain/"
```

---

## 九、性能优化

### 9.1 构建优化

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    // 代码分割
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['react', 'react-dom', 'react-router-dom'],
          'antd': ['antd', '@ant-design/icons'],
        }
      }
    },
    // 压缩
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    }
  }
});
```

### 9.2 缓存策略

| 资源类型 | 缓存时间 | 说明 |
|----------|----------|------|
| HTML | 不缓存 | 每次请求最新 |
| JS/CSS | 1年 | 文件名含hash |
| 图片 | 1年 | 静态资源 |
| API | 不缓存 | 动态数据 |

### 9.3 CDN配置

```nginx
# 静态资源使用CDN
location /assets/ {
    proxy_pass https://cdn.educhain.cc/assets/;
    expires 1y;
}
```

---

## 十、监控与日志

### 10.1 错误监控

```typescript
// 全局错误捕获
window.addEventListener('error', (event) => {
  // 上报错误
  reportError({
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno
  });
});

window.addEventListener('unhandledrejection', (event) => {
  // 上报Promise错误
  reportError({
    message: event.reason?.message || 'Unhandled Promise Rejection'
  });
});
```

### 10.2 性能监控

```typescript
// 性能指标收集
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    // 上报性能数据
    reportPerformance({
      name: entry.name,
      duration: entry.duration,
      startTime: entry.startTime
    });
  }
});

observer.observe({ entryTypes: ['navigation', 'resource', 'paint'] });
```

---

## 十一、常见问题

### 11.1 路由404问题

**问题**：刷新页面出现404

**解决**：配置Nginx的try_files
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

### 11.2 API跨域问题

**问题**：开发环境API跨域

**解决**：配置Vite代理
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true
    }
  }
}
```

### 11.3 构建内存不足

**问题**：构建时内存溢出

**解决**：增加Node内存限制
```bash
NODE_OPTIONS=--max-old-space-size=4096 npm run build
```

---

**文档结束**
